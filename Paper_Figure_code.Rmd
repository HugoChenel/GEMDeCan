---
title: "R Notebook"
output: html_notebook
---

################ Methylation paper Figure ################ 

################ Start Figure 2 and Figure S1-S2################ 

############# 100 WB GSE132203_100 samples methylation ###############

###############   BPmet  ###################

```{r}
library(Metrics)
library(reshape2)
library(scales)
library(ggpubr)
library(EpiDISH)

load("~/deconvolution/Final methylation paper/figure/Figure2 and S1_S2/Figure2_RawData.RData")

out.l <- epidish(GSE132203_100, BPmet, "RPC", maxit = 100)
GSE132203_100_BPmet <- data.frame(out.l$estF[,c(2,3,4,1,6,5)])

melt_FACS_GSE132203_100 <- melt(FACS_GSE132203_100)

melt_GSE132203_100_BPmet <- melt(GSE132203_100_BPmet) %>% cbind(melt_FACS_GSE132203_100$value, .)
colnames(melt_GSE132203_100_BPmet) <- c("FACS","cell_type","ALL")

p_GSE132203_100_BPmet_all <- ggplot(melt_GSE132203_100_BPmet,aes(x=FACS, y=ALL, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "ALL") + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.95), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.6, y = 0.15, label = paste("R = ", round(cor.test(out.l$estF[,c(2,3,4,1,6,5)], FACS_GSE132203_100)$est,3)), parse = F, size = 8) 

p_GSE132203_100_BPmet_all_longly <- ggplot(melt_GSE132203_100_BPmet,aes(x=FACS, y=ALL, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "BPmet") + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.95), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.6, y = 0.15, label = paste("R = ", round(cor.test(out.l$estF[,c(2,3,4,1,6,5)], FACS_GSE132203_100)$est,3)), parse = F, size = 8)

#### each cell types

GSE132203_100_BPmet <- cbind(GSE132203_100_BPmet, FACS_GSE132203_100)

colnames(GSE132203_100_BPmet)<-c("V","V","V","V","V","V","CD4","CD8","Mono","B","NK","Neu")


melt_GSE132203_100_BPmet <- list()
rmse <- list()
p_GSE132203_100_BPmet <- list()

for (i in c(1:6)) {
  
    rmse[[i]] <- rmse(GSE132203_100_BPmet[,i], FACS_GSE132203_100[,i])
    
    melt_GSE132203_100_BPmet[[i]] <- melt(GSE132203_100_BPmet[,c(i, i+6)],  id.vars = colnames(GSE132203_100_BPmet)[i], measure.vars = colnames(GSE132203_100_BPmet)[i+6])
}

RMSE <- data.frame(cell_type = c("CD4", "CD8", "Mono", "B", "NK", "Neu"),
                   rmse = unlist(rmse))


p_GSE132203_100_BPmet[[1]] <-  ggplot(melt_GSE132203_100_BPmet[[1]],aes(x=value, y= V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL ) + scale_y_continuous(name = NULL, limits = c(0,0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.33, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.078, y = 0.27, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6)  

p_GSE132203_100_BPmet[[2]] <- ggplot(melt_GSE132203_100_BPmet[[2]],aes(x=value, y= V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.5)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.5, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.42, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.075, y = 0.34, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)


p_GSE132203_100_BPmet[[3]] <-  ggplot(melt_GSE132203_100_BPmet[[3]],aes(x=value, y= V)) + geom_point(colour = c("blue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.33, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.074, y = 0.26, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)


p_GSE132203_100_BPmet[[4]] <- ggplot(melt_GSE132203_100_BPmet[[4]],aes(x=value, y= V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.2)) + scale_y_continuous(name = NULL, limits = c(0,0.3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.3, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.248, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.050, y = 0.2, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)

p_GSE132203_100_BPmet[[5]] <- ggplot(melt_GSE132203_100_BPmet[[5]],aes(x=value, y= V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.15)) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.165, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", 0.039, y = 0.14, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6) 

p_GSE132203_100_BPmet[[6]] <-ggplot(melt_GSE132203_100_BPmet[[6]],aes(x=value, y= V)) + geom_point(colour = c("deepskyblue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.82, size = 6)  +  theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) + annotate("text", x = 0.26, y = 0.68, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[6],2))))), parse = TRUE, size = 6)

p_GSE132203_100_BPmet_each <- ggarrange(p_GSE132203_100_BPmet[[1]],p_GSE132203_100_BPmet[[2]],p_GSE132203_100_BPmet[[3]],p_GSE132203_100_BPmet[[4]],p_GSE132203_100_BPmet[[5]],p_GSE132203_100_BPmet[[6]], ncol = 2, nrow=3)

figure_GSE132203_100_BPmet_each_together <- ggarrange(p_GSE132203_100_BPmet_all, p_GSE132203_100_BPmet_each, ncol = 2, nrow=1, labels = "a", font.label = list(size = 20, color = "black"), widths = c(1,2))

figure_GSE132203_100_BPmet_each_together <- annotate_figure(figure_GSE132203_100_BPmet_each_together, left = text_grob("BPmet estimate", color = "black", size = 20, rot = 90))

```

###############   MethylCIBERSORT  ##################

```{r}

out.l <- epidish(GSE132203_100, MethylCIBERSORT_WB, "RPC", maxit = 100)

GSE132203_100_MethylCIBERSORT_WB <- as.data.frame(cbind(out.l$estF[,3] + out.l$estF[,10], out.l$estF[,5], out.l$estF[,1], out.l$estF[,2], out.l$estF[,4], out.l$estF[,9]))

colnames(GSE132203_100_MethylCIBERSORT_WB) <- c("CD4", "CD8", "Mono", "B", "NK", "Neu")

# melt_GSE132203_100_MethylCIBERSORT_WB <- melt(GSE132203_100_MethylCIBERSORT_WB)

melt_GSE132203_100_MethylCIBERSORT_WB <- melt(GSE132203_100_MethylCIBERSORT_WB) %>% cbind(melt_FACS_GSE132203_100$value, .)
colnames(melt_GSE132203_100_MethylCIBERSORT_WB) <- c("FACS","cell_type","MethylCIBERSORT")

p_GSE132203_100_MethylCIBERSORT_WB_all <- ggplot(melt_GSE132203_100_MethylCIBERSORT_WB,aes(x=FACS, y=MethylCIBERSORT, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "ALL") + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.96), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.6, y = 0.15, label = paste("R = ", round(cor.test(out.l$estF[,c(3,5,1,2,4,9)], FACS_GSE132203_100)$est,3)), parse = F, size = 8)

p_GSE132203_100_MethylCIBERSORT_WB_all_lonly <- ggplot(melt_GSE132203_100_MethylCIBERSORT_WB,aes(x=FACS, y=MethylCIBERSORT, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "MethylCIBERSORT") + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, labels =NULL, breaks = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.96), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.6, y = 0.15, label = paste("R = ", round(cor.test(out.l$estF[,c(3,5,1,2,4,9)], FACS_GSE132203_100)$est,3)), parse = F, size = 8)
#### each cell types


GSE132203_100_MethylCIBERSORT_WB <- cbind(GSE132203_100_MethylCIBERSORT_WB, FACS_GSE132203_100)

colnames(GSE132203_100_MethylCIBERSORT_WB)<-c("V","V","V","V","V","V","CD4","CD8","Mono","B","NK", "Neu")


melt_GSE132203_100_MethylCIBERSORT_WB <- list()
rmse <- list()
p_GSE132203_100_MethylCIBERSORT <- list()

for (i in c(1:6)) {
  
    rmse[[i]] <- rmse(GSE132203_100_MethylCIBERSORT_WB[,i], GSE132203_100_MethylCIBERSORT_WB[,i+6])
    
    melt_GSE132203_100_MethylCIBERSORT_WB[[i]] <- melt(GSE132203_100_MethylCIBERSORT_WB[,c(i, i+6)],  id.vars = colnames(GSE132203_100_MethylCIBERSORT_WB)[i], measure.vars = colnames(GSE132203_100_MethylCIBERSORT_WB)[i+6])
}

RMSE <- data.frame(cell_type = c("CD4", "CD8", "Mono", "B", "NK", "Neu"),
                   rmse = unlist(rmse))


p_GSE132203_100_MethylCIBERSORT[[1]] <- ggplot(melt_GSE132203_100_MethylCIBERSORT_WB[[1]],aes(x=value, y= V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.3, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.245, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.078, y = 0.2, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6)  


p_GSE132203_100_MethylCIBERSORT[[2]] <- ggplot(melt_GSE132203_100_MethylCIBERSORT_WB[[2]],aes(x=value, y= V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.335, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.0772, y = 0.275, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

p_GSE132203_100_MethylCIBERSORT[[3]] <- ggplot(melt_GSE132203_100_MethylCIBERSORT_WB[[3]],aes(x=value, y= V)) + geom_point(colour = c("blue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.335, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.077, y = 0.275, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)

p_GSE132203_100_MethylCIBERSORT[[4]] <- ggplot(melt_GSE132203_100_MethylCIBERSORT_WB[[4]],aes(x=value, y= V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.2)) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.165, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.052, y = 0.135, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6) 

p_GSE132203_100_MethylCIBERSORT[[5]] <- ggplot(melt_GSE132203_100_MethylCIBERSORT_WB[[5]],aes(x=value, y= V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.15)) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.165, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.039, y = 0.14, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)

p_GSE132203_100_MethylCIBERSORT[[6]] <- ggplot(melt_GSE132203_100_MethylCIBERSORT_WB[[6]],aes(x=value, y= V)) + geom_point(colour = c("deepskyblue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.825, size = 6)  +  theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) + annotate("text", x = 0.26, y = 0.685, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[6],2))))), parse = TRUE, size = 6)

p_GSE132203_100_MethylCIBERSORT_each <- ggarrange(p_GSE132203_100_MethylCIBERSORT[[1]],p_GSE132203_100_MethylCIBERSORT[[2]],p_GSE132203_100_MethylCIBERSORT[[3]],p_GSE132203_100_MethylCIBERSORT[[4]],p_GSE132203_100_MethylCIBERSORT[[5]], p_GSE132203_100_MethylCIBERSORT[[6]], ncol = 2, nrow=3)



figure_GSE132203_100_MethylCIBERSORT_together <- ggarrange(p_GSE132203_100_MethylCIBERSORT_WB_all, p_GSE132203_100_MethylCIBERSORT_each, ncol = 2, nrow=1, labels = "b", font.label = list(size = 20, color = "black"), widths = c(1,2))

figure_GSE132203_100_MethylCIBERSORT_together <- annotate_figure(figure_GSE132203_100_MethylCIBERSORT_together, left = text_grob("MethylCIBERSORT estimate", color = "black", size = 20, rot = 90))

```

###############   DHS  ##################

```{r}

out.l <- epidish(GSE132203_100, centDHSbloodDMC.m, "RPC", maxit = 100)
GSE132203_100_DHS <- data.frame(out.l$estF[,c(3,4,5,1,2,6)])
colnames(GSE132203_100_DHS) <- c("CD4", "CD8", "Mono", "B", "NK", "Neu")


#melt_GSE132203_100_DHS <- melt(GSE132203_100_DHS)

melt_GSE132203_100_DHS <- melt(GSE132203_100_DHS) %>% cbind(melt_FACS_GSE132203_100$value, .)
colnames(melt_GSE132203_100_DHS) <- c("FACS","cell_type","DHS")

p_melt_GSE132203_100_DHS_all <- ggplot(melt_GSE132203_100_DHS,aes(x=FACS, y=DHS, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "ALL") + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.96), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.6, y = 0.15, label = paste("R = ", round(cor.test(out.l$estF[,c(3,4,5,1,2,6)], FACS_GSE132203_100)$est,3)), parse = F, size = 8)

p_melt_GSE132203_100_DHS_all_longly <- ggplot(melt_GSE132203_100_DHS,aes(x=FACS, y=DHS, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "DHS") + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL,labels =NULL, breaks = NULL ) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.96), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.6, y = 0.15, label = paste("R = ", round(cor.test(out.l$estF[,c(3,4,5,1,2,6)], FACS_GSE132203_100)$est,3)), parse = F, size = 8)

#### each cell types


GSE132203_100_DHS <- cbind(GSE132203_100_DHS, FACS_GSE132203_100)

colnames(GSE132203_100_DHS)<-c("V","V","V","V","V","V","CD4","CD8","Mono","B","NK", "Neu")


melt_GSE132203_100_DHS <- list()
rmse <- list()
p_GSE132203_100_DHS <- list()

for (i in c(1:6)) {
  
    rmse[[i]] <- rmse(GSE132203_100_DHS[,i], GSE132203_100_DHS[,i+6])
    
    melt_GSE132203_100_DHS[[i]] <- melt(GSE132203_100_DHS[,c(i, i+6)],  id.vars = colnames(GSE132203_100_DHS)[i], measure.vars = colnames(GSE132203_100_DHS)[i+6])
}

RMSE <- data.frame(cell_type = c("CD4", "CD8", "Mono", "B", "NK", "Neu"),
                   rmse = unlist(rmse))


p_GSE132203_100_DHS[[1]] <- ggplot(melt_GSE132203_100_DHS[[1]],aes(x=value, y= V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.33, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.078, y = 0.27, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6)  


p_GSE132203_100_DHS[[2]] <- ggplot(melt_GSE132203_100_DHS[[2]],aes(x=value, y= V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.33, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.0776, y = 0.27, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

p_GSE132203_100_DHS[[3]] <- ggplot(melt_GSE132203_100_DHS[[3]],aes(x=value, y= V)) + geom_point(colour = c("blue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.33, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.0776, y = 0.27, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)

p_GSE132203_100_DHS[[4]] <- ggplot(melt_GSE132203_100_DHS[[4]],aes(x=value, y= V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.2)) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.165, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.052, y = 0.135, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6) 

p_GSE132203_100_DHS[[5]] <- ggplot(melt_GSE132203_100_DHS[[5]],aes(x=value, y= V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.15)) + scale_y_continuous(name = NULL, limits = c(0,0.3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.3, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.255, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.039, y = 0.215, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)

p_GSE132203_100_DHS[[6]] <-ggplot(melt_GSE132203_100_DHS[[6]],aes(x=value, y= V)) + geom_point(colour = c("deepskyblue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,1.1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 1.1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.925, size = 6)  +  theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) + annotate("text", x = 0.253, y = 0.78, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[6],2))))), parse = TRUE, size = 6)

p_GSE132203_100_DHS_each <- ggarrange(p_GSE132203_100_DHS[[1]],p_GSE132203_100_DHS[[2]],p_GSE132203_100_DHS[[3]],p_GSE132203_100_DHS[[4]],p_GSE132203_100_DHS[[5]], p_GSE132203_100_DHS[[6]], ncol = 2, nrow = 3)



figure_GSE132203_100_DHS_all_together <- ggarrange(p_melt_GSE132203_100_DHS_all, p_GSE132203_100_DHS_each, ncol = 2, nrow=1, labels = "c", font.label = list(size = 20, color = "black"), widths = c(1,2))

figure_GSE132203_100_DHS_all_together <- annotate_figure(figure_GSE132203_100_DHS_all_together, left = text_grob("DHS estimate", color = "black", size = 20, rot = 90), bottom = text_grob("Gold standard", color = "black", size = 20))
  
```


############## methylation 6 WB samples GSE77797 ############## 

############## BPmet ###################

```{r}

out.l <- epidish(GSE77797_six, BPmet, "RPC", maxit = 100)
GSE77797_six_BPmet <- data.frame(out.l$estF[,c(2,3,4,1,6)])
#melt_GSE77797_six_BPmet <- melt(GSE77797_six_BPmet)
melt_facs_GSE77797_six <- melt(facs_GSE77797_six[,-6])

melt_GSE77797_six_BPmet <- melt(GSE77797_six_BPmet) %>% cbind(melt_facs_GSE77797_six$value, .)
colnames(melt_GSE77797_six_BPmet) <- c("FACS","cell_type","BPmet")

p_GSE77797_six_BPmet_all <- ggplot(melt_GSE77797_six_BPmet,aes(x=FACS, y=BPmet, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "ALL") + scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.95), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.24, y = 0.05, label = paste("R = ", round(cor.test(out.l$estF[,c(2,3,4,1,6)], facs_GSE77797_six[,-6])$est,2)), parse = F, size = 8)

p_GSE77797_six_BPmet_all_longly <- ggplot(melt_GSE77797_six_BPmet,aes(x=FACS, y=BPmet, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "BPmet") + scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.95), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.24, y = 0.05, label = paste("R = ", round(cor.test(out.l$estF[,c(2,3,4,1,6)], facs_GSE77797_six[,-6])$est,2)), parse = F, size = 8) 

#### each cell types


GSE77797_six_BPmet <- cbind(GSE77797_six_BPmet, facs_GSE77797_six[,-6])

colnames(GSE77797_six_BPmet)<-c("V","V","V","V","V","CD4","CD8","Mono","B","NK")


melt_GSE77797_six_BPmet <- list()
rmse <- list()
G6_BPmet <- list()

for (i in c(1:5)) {
  
    rmse[[i]] <- rmse(GSE77797_six_BPmet[,i], GSE77797_six_BPmet[,i+5])
    
    melt_GSE77797_six_BPmet[[i]] <- melt(GSE77797_six_BPmet[,c(i, i+5)],  id.vars = colnames(GSE77797_six_BPmet)[i], measure.vars = colnames(GSE77797_six_BPmet)[i+5])
}

RMSE <- data.frame(cell_type = c("CD4", "CD8", "Mono", "B", "NK"),
                   rmse = unlist(rmse))


G6_BPmet[[1]] <- ggplot(melt_GSE77797_six_BPmet[[1]],aes(x=value, y= V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0, 0.3)) + scale_y_continuous(name = NULL, limits = c(0, 0.3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.3, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.255, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.08, y = 0.21, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6) 


G6_BPmet[[2]] <- ggplot(melt_GSE77797_six_BPmet[[2]],aes(x=value, y= V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL, limits = c(0, 0.3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.3, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.25, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.04, y = 0.21, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

G6_BPmet[[3]] <- ggplot(melt_GSE77797_six_BPmet[[3]],aes(x=value, y= V)) + geom_point(colour = c("blue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.09)) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.17, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.025, y = 0.14, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)


G6_BPmet[[4]] <- ggplot(melt_GSE77797_six_BPmet[[4]],aes(x=value, y= V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.09)) + scale_y_continuous(name = NULL, limits = c(0,0.15)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.15, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.13, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.025, y = 0.11, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)


G6_BPmet[[5]] <- ggplot(melt_GSE77797_six_BPmet[[5]],aes(x=value, y= V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.05)) + scale_y_continuous(name = NULL, limits = c(0,0.15)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.15, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.13, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.0138, y = 0.11, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)


p_GSE77797_six_BPmet_each <- ggarrange(G6_BPmet[[1]],G6_BPmet[[2]],G6_BPmet[[3]],G6_BPmet[[4]],G6_BPmet[[5]], ncol = 2, nrow=3)

figure_GSE77797_six_BPmet_together <- ggarrange(p_GSE77797_six_BPmet_all, p_GSE77797_six_BPmet_each, ncol = 2, nrow=1, labels = "a", font.label = list(size = 20, color = "black"), widths = c(1,2))

figure_GSE77797_six_BPmet_together <- annotate_figure(figure_GSE77797_six_BPmet_together,  left = text_grob("BPmet estimate", color = "black", size = 20, rot = 90))

```

###################### MethylCIBERSORT_WB #########################

```{r}

out.l <- epidish(GSE77797_six, MethylCIBERSORT_WB, "RPC", maxit = 100)
GSE77797_six_MethylCIBERSORT_WB <- data.frame(out.l$estF[,c(3,5,1,2,4)])



# melt_GSE77797_six_MethylCIBERSORT_WB <- melt(GSE77797_six_MethylCIBERSORT_WB)

melt_GSE77797_six_MethylCIBERSORT_WB <- melt(GSE77797_six_MethylCIBERSORT_WB) %>% cbind(melt_facs_GSE77797_six$value, .)
colnames(melt_GSE77797_six_MethylCIBERSORT_WB) <- c("FACS","cell_type","MethylCIBERSORT")

p_GSE77797_six_MethylCIBERSORT_all <- ggplot(melt_GSE77797_six_MethylCIBERSORT_WB,aes(x=FACS, y=MethylCIBERSORT, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "ALL") + scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.96), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.24, y = 0.05, label = paste("R = ", round(cor.test(out.l$estF[,c(3,5,1,2,4)], facs_GSE77797_six[,-6])$est,2)), parse = F, size = 8)

p_GSE77797_six_MethylCIBERSORT_all_longly <- ggplot(melt_GSE77797_six_MethylCIBERSORT_WB,aes(x=FACS, y=MethylCIBERSORT, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "MethylCIBERSORT") + scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, breaks = NULL, labels = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.96), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.24, y = 0.05,  label = paste("R = ", round(cor.test(out.l$estF[,c(3,5,1,2,4)], facs_GSE77797_six[,-6])$est,2)), parse = F, size = 8)
#### each cell types


GSE77797_six_MethylCIBERSORT_WB <- cbind(GSE77797_six_MethylCIBERSORT_WB, facs_GSE77797_six[,-6])

colnames(GSE77797_six_MethylCIBERSORT_WB)<-c("V","V","V","V","V","CD4","CD8","Mono","B","NK")


melt_GSE77797_six_MethylCIBERSORT_WB <- list()
rmse <- list()
G6_MethylCIBERSORT_WB <- list()

for (i in c(1:5)) {
  
    rmse[[i]] <- rmse(GSE77797_six_MethylCIBERSORT_WB[,i], GSE77797_six_MethylCIBERSORT_WB[,i+5])
    
    melt_GSE77797_six_MethylCIBERSORT_WB[[i]] <- melt(GSE77797_six_MethylCIBERSORT_WB[,c(i, i+5)],  id.vars = colnames(GSE77797_six_MethylCIBERSORT_WB)[i], measure.vars = colnames(GSE77797_six_MethylCIBERSORT_WB)[i+5])
}

RMSE <- data.frame(cell_type = c("CD4", "CD8", "Mono", "B", "NK"),
                   rmse = unlist(rmse))


G6_MethylCIBERSORT_WB[[1]] <-  ggplot(melt_GSE77797_six_MethylCIBERSORT_WB[[1]],aes(x=value, y= V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0, 0.3)) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.3, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.255, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.082, y = 0.21, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6) 


G6_MethylCIBERSORT_WB[[2]] <- ggplot(melt_GSE77797_six_MethylCIBERSORT_WB[[2]],aes(x=value, y= V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.17, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.043, y = 0.145, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

G6_MethylCIBERSORT_WB[[3]] <- ggplot(melt_GSE77797_six_MethylCIBERSORT_WB[[3]],aes(x=value, y= V)) + geom_point(colour = c("blue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.09)) + scale_y_continuous(name = NULL, limits = c(0,0.15)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.15, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.13, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.025, y = 0.11, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)

G6_MethylCIBERSORT_WB[[4]] <- ggplot(melt_GSE77797_six_MethylCIBERSORT_WB[[4]],aes(x=value, y= V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.09)) + scale_y_continuous(name = NULL, limits = c(0,0.15)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.15, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.13, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.026, y = 0.11, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)
  
  
G6_MethylCIBERSORT_WB[[5]] <- ggplot(melt_GSE77797_six_MethylCIBERSORT_WB[[5]],aes(x=value, y= V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.05)) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.17, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.0138, y = 0.145, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)

p_GSE77797_six_MethylCIBERSORT_WB_each <- ggarrange(G6_MethylCIBERSORT_WB[[1]],G6_MethylCIBERSORT_WB[[2]],G6_MethylCIBERSORT_WB[[3]],G6_MethylCIBERSORT_WB[[4]],G6_MethylCIBERSORT_WB[[5]], ncol = 2, nrow = 3)



figure_GSE77797_six_MethylCIBERSORT_WB_together <- ggarrange(p_GSE77797_six_MethylCIBERSORT_all, p_GSE77797_six_MethylCIBERSORT_WB_each, ncol = 2, nrow=1, labels = "b", font.label = list(size = 20, color = "black"), widths = c(1,2))

figure_GSE77797_six_MethylCIBERSORT_WB_together <- annotate_figure(figure_GSE77797_six_MethylCIBERSORT_WB_together, left = text_grob("MethylCIBERSORT estimate", color = "black", size = 20, rot = 90))


# p_GSE77797_six_MethylCIBERSORT_each <- ggplot(melt_GSE77797_six_MethylCIBERSORT_WB,aes(x=FACS, y=MethylCIBERSORT, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ cell_type) + scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.position="none")  + stat_cor(aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.28, size = 6, color = "black") + geom_text(data = RMSE, aes(x = 0.065, y = 0.24, label = paste('RMSE =', round(rmse,2))), color = "black", size = 5.5)
# 
# figure_GSE77797_six_MethylCIBERSORT_each <- ggarrange(p_GSE77797_six_MethylCIBERSORT_all, p_GSE77797_six_MethylCIBERSORT_each, ncol = 2, nrow=1, labels = "b", font.label = list(size = 20, color = "black"), widths = c(1,2.5))
# 
# annotate_figure(figure_GSE77797_six_MethylCIBERSORT_each, bottom = text_grob("Gold standard", color = "black", size = 20), left = text_grob("EpiDISH estimate", color = "black", size = 20, rot = 90))
```

###################### DHS #########################

```{r}

out.l <- epidish(GSE77797_six, centDHSbloodDMC.m, "RPC", maxit = 100)
GSE77797_six_DHS <- data.frame(out.l$estF[,c(3,4,5,1,2)])
colnames(GSE77797_six_DHS) <- c("CD4", "CD8", "Mono", "B", "NK")




#melt_GSE77797_six_DHS <- melt(GSE77797_six_DHS)

melt_GSE77797_six_DHS <- melt(GSE77797_six_DHS) %>% cbind(melt_facs_GSE77797_six$value, .)
colnames(melt_GSE77797_six_DHS) <- c("FACS","cell_type","DHS")

p_GSE77797_six_DHS_all <- ggplot(melt_GSE77797_six_DHS,aes(x=FACS, y=DHS, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "ALL") + scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.95), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.24, y = 0.05, label = paste("R = ", round(cor.test(out.l$estF[,c(3,4,5,1,2)], facs_GSE77797_six[,-6])$est,2)), parse = F, size = 8)

p_GSE77797_six_DHS_all_longly <- ggplot(melt_GSE77797_six_DHS,aes(x=FACS, y=DHS, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "DHS") + scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, breaks = NULL, labels = NULL) + theme(strip.text.x = element_text(size = 18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.95), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.24, y = 0.05, label = paste("R = ", round(cor.test(out.l$estF[,c(3,4,5,1,2)], facs_GSE77797_six[,-6])$est,2)), parse = F, size = 8)

#################################################################################

#### each cell types

GSE77797_six_DHS <- cbind(GSE77797_six_DHS, facs_GSE77797_six[,-6])

colnames(GSE77797_six_DHS)<-c("V","V","V","V","V","CD4","CD8","Mono","B","NK")


melt_GSE77797_six_DHS <- list()
rmse <- list()
G6_DHS <- list()

for (i in c(1:5)) {
  
    rmse[[i]] <- rmse(GSE77797_six_DHS[,i], GSE77797_six_DHS[,i+5])
    
    melt_GSE77797_six_DHS[[i]] <- melt(GSE77797_six_DHS[,c(i, i+5)],  id.vars = colnames(GSE77797_six_DHS)[i], measure.vars = colnames(GSE77797_six_DHS)[i+5])
}

RMSE <- data.frame(cell_type = c("CD4", "CD8", "Mono", "B", "NK"),
                   rmse = unlist(rmse))


G6_DHS[[1]] <- ggplot(melt_GSE77797_six_DHS[[1]],aes(x = value, y= V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.34, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.082, y = 0.285, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6)

G6_DHS[[2]] <- ggplot(melt_GSE77797_six_DHS[[2]],aes(x=value, y= V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.17, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.043, y = 0.145, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

G6_DHS[[3]] <- ggplot(melt_GSE77797_six_DHS[[3]],aes(x=value, y= V)) + geom_point(colour = c("blue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.09)) + scale_y_continuous(name = NULL, limits = c(0,0.15)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.15, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.13, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.025, y = 0.11, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)

G6_DHS[[4]] <- ggplot(melt_GSE77797_six_DHS[[4]],aes(x=value, y= V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,0.15)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.15, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.13, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.022, y = 0.11, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)

G6_DHS[[5]] <- ggplot(melt_GSE77797_six_DHS[[5]],aes(x=value, y= V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.06)) + scale_y_continuous(name = NULL, limits = c(0,0.15)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.15, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.13, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.017, y = 0.11, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)


p_GSE77797_six_DHS_each <- ggarrange(G6_DHS[[1]],G6_DHS[[2]],G6_DHS[[3]],G6_DHS[[4]],G6_DHS[[5]], ncol = 2, nrow=3)

figure_GSE77797_six_DHS_together <- ggarrange(p_GSE77797_six_DHS_all, p_GSE77797_six_DHS_each, ncol = 2, nrow=1, labels = "c", font.label = list(size = 20, color = "black"), widths = c(1,2))

figure_GSE77797_six_DHS_together <- annotate_figure(figure_GSE77797_six_DHS_together,  left = text_grob("DHS estimate", color = "black", size = 20, rot = 90), bottom = text_grob("Gold standard", color = "black", size = 20))





figure_GSE77797_six_BPmet_MethylCIBERSORT_DHS_together <- ggarrange(figure_GSE77797_six_BPmet_together,figure_GSE77797_six_MethylCIBERSORT_WB_together, figure_GSE77797_six_DHS_together, ncol = 1, nrow=3)

annotate_figure(figure_GSE77797_six_BPmet_MethylCIBERSORT_DHS_together, bottom = text_grob("Gold standard", color = "black", size = 20))

# p_GSE77797_six_DHS_each <- ggplot(melt_GSE77797_six_DHS,aes(x=FACS, y=DHS, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ cell_type) + scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.position="none")  + stat_cor(aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.28, size = 6, color = "black") + geom_text(data = RMSE, aes(x = 0.065, y = 0.24, label = paste('RMSE =', round(rmse,2))), color = "black", size = 5.5)
# 
# figure_GSE77797_six_DHS_each <- ggarrange(p_GSE77797_six_DHS_all, p_GSE77797_six_DHS_each, ncol = 2, nrow=1, labels = "c", font.label = list(size = 20, color = "black"), widths = c(1,2.5))
# 
# annotate_figure(figure_GSE77797_six_DHS_each, bottom = text_grob("Gold standard", color = "black", size = 20), left = text_grob("EpiDISH estimate", color = "black", size = 20, rot = 90))

```

########## Figure 2 and Figure S1-S2  ############

```{r}

figure_GSE132203_100_all_together <- ggarrange(p_GSE132203_100_BPmet_all_longly,p_GSE132203_100_MethylCIBERSORT_WB_all_lonly ,p_melt_GSE132203_100_DHS_all_longly, ncol = 3, nrow = 1, labels = "a", font.label = list(size = 20, color = "black"))

figure_GSE77797_all_together <- ggarrange(p_GSE77797_six_BPmet_all_longly,p_GSE77797_six_MethylCIBERSORT_all_longly ,p_GSE77797_six_DHS_all_longly, ncol = 3, nrow = 1, labels = "b", font.label = list(size = 20, color = "black"))

Figure2 <- annotate_figure(ggarrange(figure_GSE132203_100_all_together, figure_GSE77797_all_together, ncol = 1, nrow = 2), bottom = text_grob("Gold standard", color = "black", size = 20))

Figure_S1a <- figure_GSE132203_100_BPmet_each_together
Figure_S1b <- figure_GSE132203_100_MethylCIBERSORT_together
Figure_S1c <- figure_GSE132203_100_DHS_all_together


Figure_S2a <- figure_GSE77797_six_BPmet_together
Figure_S2b <- figure_GSE77797_six_MethylCIBERSORT_WB_together
Figure_S2c <- figure_GSE77797_six_DHS_together

# figure_GSE132203_100_all_signatures <- ggarrange( figure_GSE132203_100_BPmet_each_together, figure_GSE132203_100_MethylCIBERSORT_together, figure_GSE132203_100_DHS_all_together, ncol = 1, nrow = 3)
# 
# figure_GSE132203_100_DHS_all_together <- annotate_figure(figure_GSE132203_100_DHS_all_together, bottom = text_grob("Gold standard", color = "black", size = 20))

```




############################ Start Figure 3 ############################ 

##########  methylation TCGA-LUAD with previous tumor purity methods ############

############## BPmetCan and MethylCIBERSORT_Luad ###################

```{r}
library(reshape2)
library(scales)
library(ggpubr)
library(EpiDISH)

load("/home/ting/deconvolution/Final methylation paper/figure/Figure3 and S3/Figure3_and_S3.RData")

out.l <- epidish(ABSOLUTE.LUAD.Aran, BPmetCan, "RPC", maxit = 100)
TCGA_LUAD_BPmetCan <- data.frame(out.l$estF)
  
out.l <- epidish(ABSOLUTE.LUAD.Aran, MethylCIBERSORT_LUAD, "RPC", maxit = 100)
TCGA_LUAD_MethylCIBERSORT_LUAD <- data.frame(out.l$estF)

TCGA_LUAD_BPmetCan_MethylCIBERSORT<-as.data.frame(cbind(FACS.ABSOLUTE.LUAD.Aran$ABSOLUTE,TCGA_LUAD_BPmetCan$cancer, TCGA_LUAD_MethylCIBERSORT_LUAD$Cancer, FACS.ABSOLUTE.LUAD.Aran$ESTIMATE,FACS.ABSOLUTE.LUAD.Aran$LUMP,FACS.ABSOLUTE.LUAD.Aran$IHC))

colnames(TCGA_LUAD_BPmetCan_MethylCIBERSORT) <- c("ABSOLUTE", "BPmetCan", "MethylCIBERSORT","ESTIMATE","LUMP","IHC")

melt_TCGA_LUAD_BPmetCan_MethylCIBERSORT<-melt(TCGA_LUAD_BPmetCan_MethylCIBERSORT,  id.vars = "ABSOLUTE", measure.vars = c("BPmetCan", "MethylCIBERSORT","ESTIMATE","LUMP","IHC"))

p_TCGA_LUAD_BPmetCan_MethylCIBERSORT <-  ggplot(melt_TCGA_LUAD_BPmetCan_MethylCIBERSORT,aes(x=value, y = ABSOLUTE)) + geom_point(colour = "brown") + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable, ncol = 2) + scale_x_continuous(name = "Method purity estimate", limits = c(0,1)) + scale_y_continuous(name = "ABSOLUTE estimate",limits = c(0,1)) + theme(strip.text.x = element_text(size = 18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.9, size = 6) + stat_cor(aes(label = paste(..p.label..)), label.x = 0, label.y = 0.68, size = 6) + theme(axis.title.x = element_text(vjust = -0.5)) + theme(axis.title.y = element_text(vjust = 1.5)) #+ labs(tag = "a")




```

##########  methylation TCGA-BRCA with previous tumor purity methods ########## 

############## BPmetCan and MethylCIBERSORT_breast ###################

```{r}

out.l <- epidish(TCGA_BRCA_450k, BPmetCan, "RPC", maxit = 100)
TCGA_BRCA_BPmetCan <- data.frame(out.l$estF)

out.l <- epidish(TCGA_BRCA_450k, MethylCIBERSORT_brest, "RPC", maxit = 100)
TCGA_BRCA_MethylCIBERSORT <- data.frame(out.l$estF)

TCGA_BRCA_BPmetCan_MethylCIBERSORT<-as.data.frame(cbind(FACS_Aran_BRCA$ABSOLUTE,TCGA_BRCA_BPmetCan$cancer, TCGA_BRCA_MethylCIBERSORT$Cancer, FACS_Aran_BRCA$ESTIMATE,FACS_Aran_BRCA$LUMP,FACS_Aran_BRCA$IHC))

colnames(TCGA_BRCA_BPmetCan_MethylCIBERSORT) <- c("ABSOLUTE", "BPmetCan", "MethylCIBERSORT","ESTIMATE","LUMP","IHC")

melt_TCGA_BRCA_BPmetCan_MethylCIBERSORT <- melt(TCGA_BRCA_BPmetCan_MethylCIBERSORT,  id.vars = "ABSOLUTE", measure.vars = c("BPmetCan", "MethylCIBERSORT","ESTIMATE","LUMP","IHC"))

p_TCGA_BRCA_BPmetCan_MethylCIBERSORT <-  ggplot(melt_TCGA_BRCA_BPmetCan_MethylCIBERSORT,aes(x = value, y = ABSOLUTE)) + geom_point(colour = "brown") + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable, ncol = 2) + scale_x_continuous(name = "Method purity estimate", limits = c(0,1)) + scale_y_continuous(name = "ABSOLUTE estimate",limits = c(0,1)) + theme(strip.text.x = element_text(size = 18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0.6, label.y = 0.1, size = 6) + stat_cor(aes(label = paste(..p.label..)), label.x = 0.6, label.y = 0, size = 6) + theme(axis.title.x = element_text(vjust = -0.5)) + theme(axis.title.y = element_text(vjust=1.5)) #+ labs(tag = "b")


```

############################ DNA methylation lymphocytes ###################################

############################ BPmetCan ###################################

# Lymphocytes: CD4 + Tregs + CD8 + B + NK

# Monocytes/Macrophages lineage: M0 + M1 + M2 + Monocytes

# Neutrophiles: Neutrophils

```{r}

out.l <- epidish(TCGA_LUAD_Methylation, BPmetCan, "RPC")
TCGA_LUAD_BPmetCan_lymphocytes_deconv <- data.frame(out.l$estF)

TCGA_LUAD_BPmetCan_lymphocytes <- cbind((TCGA_LUAD_BPmetCan_lymphocytes_deconv$B + TCGA_LUAD_BPmetCan_lymphocytes_deconv$CD4 + TCGA_LUAD_BPmetCan_lymphocytes_deconv$CD8 + TCGA_LUAD_BPmetCan_lymphocytes_deconv$NK + TCGA_LUAD_BPmetCan_lymphocytes_deconv$Treg), FACS_TCGA_LUAD_BPmetCan_lymphocytes$Lymphocytes)
colnames(TCGA_LUAD_BPmetCan_lymphocytes) <- c("estimate", "facs")

TCGA_LUAD_BPmetCan_Macrophages <- cbind((TCGA_LUAD_BPmetCan_lymphocytes_deconv$M0 + TCGA_LUAD_BPmetCan_lymphocytes_deconv$M1 + TCGA_LUAD_BPmetCan_lymphocytes_deconv$M2 + TCGA_LUAD_BPmetCan_lymphocytes_deconv$Mono), FACS_TCGA_LUAD_BPmetCan_lymphocytes$Macrophages)
colnames(TCGA_LUAD_BPmetCan_Macrophages) <- c("estimate", "facs")

TCGA_LUAD_BPmetCan_Neutrophils <- cbind((TCGA_LUAD_BPmetCan_lymphocytes_deconv$Neu), FACS_TCGA_LUAD_BPmetCan_lymphocytes$Neutrophils)
colnames(TCGA_LUAD_BPmetCan_Neutrophils) <- c("estimate", "facs")

p_TCGA_LUAD_BPmetCan_lymphocytes <- ggplot(as.data.frame(TCGA_LUAD_BPmetCan_lymphocytes),aes(x = facs, y= estimate)) + geom_point(colour = c("darkslategrey")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "lymphocytes")+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.8, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.72, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5))

p_TCGA_LUAD_BPmetCan_Macrophages <- ggplot(as.data.frame(TCGA_LUAD_BPmetCan_Macrophages),aes(x=estimate, y= facs)) + geom_point(colour = c("coral")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "Macrophages")+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.36, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) 

p_TCGA_LUAD_BPmetCan_Neutrophils <- ggplot(as.data.frame(TCGA_LUAD_BPmetCan_Neutrophils[-144,]),aes(x = facs, y = estimate )) + geom_point(colour = c("deepskyblue")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "Neutrophils")+ scale_x_continuous(name = NULL, limits = c(0,0.03)) + scale_y_continuous(name = NULL, limits = c(0,0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.36, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5))



```

############## MethylCIBERSORT #####################

# Lymphocytes: CD4 + Tregs + CD8 + B + NK

# Monocytes/Macrophages lineage: Monocytes

# Neutrophiles: Neutrophils
```{r}

out.l <- epidish(TCGA_LUAD_Methylation, MethylCIBERSORT_LUAD, "RPC")
TCGA_LUAD_MethylCIBERSORT_lymphocytes_deconv <- data.frame(out.l$estF)

TCGA_LUAD_MethylCIBERSORT_lymphocytes <- cbind(( TCGA_LUAD_MethylCIBERSORT_lymphocytes_deconv$CD4 + TCGA_LUAD_MethylCIBERSORT_lymphocytes_deconv$CD8 + TCGA_LUAD_MethylCIBERSORT_lymphocytes_deconv$NK + TCGA_LUAD_MethylCIBERSORT_lymphocytes_deconv$B + TCGA_LUAD_MethylCIBERSORT_lymphocytes_deconv$Treg), FACS_TCGA_LUAD_BPmetCan_lymphocytes$Lymphocytes)
colnames(TCGA_LUAD_MethylCIBERSORT_lymphocytes) <- c("estimate", "facs")

TCGA_LUAD_MethylCIBERSORT_Macrophages <- cbind((TCGA_LUAD_MethylCIBERSORT_lymphocytes_deconv$Mono), FACS_TCGA_LUAD_BPmetCan_lymphocytes$Macrophages)
colnames(TCGA_LUAD_MethylCIBERSORT_Macrophages) <- c("estimate", "facs")

TCGA_LUAD_MethylCIBERSORT_Neutrophils <- cbind((TCGA_LUAD_MethylCIBERSORT_lymphocytes_deconv$Neu), FACS_TCGA_LUAD_BPmetCan_lymphocytes$Neutrophils)
colnames(TCGA_LUAD_MethylCIBERSORT_Neutrophils) <- c("estimate", "facs")

p_TCGA_LUAD_MethylCIBERSORT_lymphocytes <- ggplot(as.data.frame(TCGA_LUAD_MethylCIBERSORT_lymphocytes), aes(x = facs, y= estimate)) + geom_point(colour = c("darkslategrey")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "lymphocytes")+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.8, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.72, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5))

p_TCGA_LUAD_MethylCIBERSORT_Macrophages <- ggplot(as.data.frame(TCGA_LUAD_MethylCIBERSORT_Macrophages),aes(x=facs, y=estimate )) + geom_point(colour = c("coral")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "Macrophages")+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.36, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) 

p_TCGA_LUAD_MethylCIBERSORT_Neutrophils <- ggplot(as.data.frame(TCGA_LUAD_MethylCIBERSORT_Neutrophils),aes(x = facs, y = estimate )) + geom_point(colour = c("deepskyblue")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "Neutrophils")+ scale_x_continuous(name = NULL, limits = c(0,0.03)) + scale_y_continuous(name = NULL, limits = c(0,0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.36, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5))

figure_TCGA_LUAD_MethylCIBERSORT <- ggarrange(p_TCGA_LUAD_MethylCIBERSORT_lymphocytes, p_TCGA_LUAD_MethylCIBERSORT_Macrophages, p_TCGA_LUAD_MethylCIBERSORT_Neutrophils, ncol = 3, nrow=1, labels = "c", font.label = list(size = 20, color = "black"))

# annotate_figure_TCGA_LUAD_MethylCIBERSORT <- annotate_figure(figure_TCGA_LUAD_MethylCIBERSORT, left = text_grob("MethylCIBERSORT estimate", color = "black", size = 20, rot = 90))
# 
# 
# annotate_TCGA_LUAD_BPmetCan_MethylCIBERSORT <- ggarrange(annotate_figure_TCGA_LUAD_BPmetCan, annotate_figure_TCGA_LUAD_MethylCIBERSORT, ncol = 1, nrow = 2)
# 
# annotate_TCGA_LUAD_BPmetCan_MethylCIBERSORT <- annotate_figure(annotate_TCGA_LUAD_BPmetCan_MethylCIBERSORT, bottom = text_grob("H&E estimate", color = "black", size = 20))

```

############## Options DHS #####################

# Lymphocytes: CD4 + CD8 + B + NK

# Monocytes/Macrophages lineage: Monocytes

# Neutrophiles: Neutrophils

```{r}
# out.l <- epidish(TCGA_LUAD_Mthylation, centDHSbloodDMC.m, "RPC", maxit = 100)
# TCGA_LUAD_Methylation_DHS_lymphocytes_deconv <- data.frame(out.l$estF)
# TCGA_LUAD_Methylation_DHS_lymphocytes_deconv <- TCGA_LUAD_Methylation_DHS_lymphocytes_deconv[rownames(TCGA_LUAD_Methylation_DHS_lymphocytes_deconv)%in%rownames(FACS_TCGA_LUAD_BPmetCan_lymphocytes),]
# 
# 
# TCGA_LUAD_DHS_lymphocytes <- cbind((TCGA_LUAD_Methylation_DHS_lymphocytes_deconv$CD4T + TCGA_LUAD_Methylation_DHS_lymphocytes_deconv$CD8T + TCGA_LUAD_Methylation_DHS_lymphocytes_deconv$NK + TCGA_LUAD_Methylation_DHS_lymphocytes_deconv$B), FACS_TCGA_LUAD_BPmetCan_lymphocytes$Lymphocytes)
# colnames(TCGA_LUAD_DHS_lymphocytes) <- c("estimate", "facs")
# 
# TCGA_LUAD_DHS_Macrophages <- cbind((TCGA_LUAD_Methylation_DHS_lymphocytes_deconv$Mono), FACS_TCGA_LUAD_BPmetCan_lymphocytes$Macrophages)
# colnames(TCGA_LUAD_DHS_Macrophages) <- c("estimate", "facs")
# 
# TCGA_LUAD_DHS_Neutrophils <- cbind((TCGA_LUAD_Methylation_DHS_lymphocytes_deconv$Neu), FACS_TCGA_LUAD_BPmetCan_lymphocytes$Neutrophils)
# colnames(TCGA_LUAD_DHS_Neutrophils) <- c("estimate", "facs")
# 
# p_TCGA_LUAD_DHS_lymphocytes <- ggplot(as.data.frame(TCGA_LUAD_DHS_lymphocytes), aes(x = facs, y= estimate)) + geom_point(colour = c("darkslategrey")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "lymphocytes")+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 1.15, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 1.05, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5))
# 
# p_TCGA_LUAD_DHS_Macrophages <- ggplot(as.data.frame(TCGA_LUAD_DHS_Macrophages),aes(x=facs, y=estimate )) + geom_point(colour = c("yellow2")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "Macrophages")+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.8, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.73, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5))
# 
# p_TCGA_LUAD_DHS_Neutrophils <- ggplot(as.data.frame(TCGA_LUAD_DHS_Neutrophils),aes(x = facs, y = estimate )) + geom_point(colour = c("deepskyblue")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "Neutrophils")+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.8, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.73, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5))
# 
# figure_TCGA_LUAD_DHS <- ggarrange(p_TCGA_LUAD_DHS_lymphocytes, p_TCGA_LUAD_DHS_Macrophages, p_TCGA_LUAD_DHS_Neutrophils, ncol = 3, nrow=1, labels = "c", font.label = list(size = 20, color = "black"))
# 
# annotate_figure(figure_TCGA_LUAD_DHS, left = text_grob("DHS estimates", color = "black", size = 20, rot = 90), bottom = text_grob("H&E estimates", color = "black", size = 20))
# 
```

########### Figure 3 and Figure S3  #################
```{r}

#### Figure 3 #####

figure_LUAD_methy <- ggarrange(p_TCGA_LUAD_BPmetCan_MethylCIBERSORT, ncol = 1, nrow =1, labels = "a", font.label = list(size = 20, color = "black"))


figure_TCGA_LUAD_BPmetCan <- ggarrange(p_TCGA_LUAD_BPmetCan_lymphocytes, p_TCGA_LUAD_BPmetCan_Macrophages, p_TCGA_LUAD_BPmetCan_Neutrophils, ncol = 3, nrow=1, font.label = list(size = 20, color = "black"))

figure_TCGA_LUAD_BPmetCan <- annotate_figure(figure_TCGA_LUAD_BPmetCan, left = text_grob("BPmetCan estimate", color = "black", size = 20, rot = 90))


figure_TCGA_LUAD_MethylCIBERSORT <- ggarrange(p_TCGA_LUAD_MethylCIBERSORT_lymphocytes, p_TCGA_LUAD_MethylCIBERSORT_Macrophages, p_TCGA_LUAD_MethylCIBERSORT_Neutrophils, ncol = 3, nrow=1, font.label = list(size = 20, color = "black"))

figure_TCGA_LUAD_MethylCIBERSORT <- annotate_figure(figure_TCGA_LUAD_MethylCIBERSORT, left = text_grob("MethylCIBERSORT estimate", color = "black", size = 20, rot = 90))


TCGA_LUAD_BPmetCan_MethylCIBERSORT <- ggarrange(figure_TCGA_LUAD_BPmetCan, figure_TCGA_LUAD_MethylCIBERSORT, ncol = 1, nrow = 2, labels = "b", font.label = list(size = 20, color = "black"))

annotate_TCGA_LUAD_BPmetCan_MethylCIBERSORT <- annotate_figure(TCGA_LUAD_BPmetCan_MethylCIBERSORT, bottom = text_grob("H&E estimate", color = "black", size = 20))


Figure3 <- ggarrange(figure_LUAD_methy, annotate_TCGA_LUAD_BPmetCan_MethylCIBERSORT, ncol = 1, nrow = 2)


#### Figure S3 #####

Figure_S3 <- ggarrange(p_TCGA_BRCA_BPmetCan_MethylCIBERSORT, ncol = 1, nrow = 1)


```





############################ Start Figure 4 ############################ 

############################ RNAseq lymphocytes ###################################

##########  RNAseq GSE107011 PBMC Monaco ############

############## BPRNA ###################

```{r}
library(Metrics)

load("~/deconvolution/Final methylation paper/figure/Figure4/GSE107011_PBMCs_Fig4.RData")

out.l <- epidish(GSE107011, as.matrix(BPRNA), "RPC", maxit = 100)
BPRNA_EpiDISH <- data.frame(out.l$estF)

GSE107011_BPRNA_EpiDISH_modify <- cbind(BPRNA_EpiDISH[, c(2,3,4,1,6,5)])

#melt_GSE107011_BPRNA_EpiDISH_modify <- melt(GSE107011_BPRNA_EpiDISH_modify)
melt_FACS_GSE107011 <- melt(FACS_GSE107011[, c(1,2,4,3,5,6)]/100)

melt_GSE107011_BPRNA_EpiDISH_modify_FACS <- melt(GSE107011_BPRNA_EpiDISH_modify) %>% cbind(melt_FACS_GSE107011$value, .)
colnames(melt_GSE107011_BPRNA_EpiDISH_modify_FACS) <- c("FACS","cell_type","ALL")

p_melt_GSE107011_BPRNA_EpiDISH_modify_all <- ggplot(melt_GSE107011_BPRNA_EpiDISH_modify_FACS,aes(x = FACS, y = ALL, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "ALL") + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.8)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.95), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.3, y = 0, label = paste("R = ", round(cor.test(as.matrix(GSE107011_BPRNA_EpiDISH_modify), as.matrix(FACS_GSE107011[, c(1,2,4,3,5,6)]))$est,2)), parse = F, size = 8)


p_melt_GSE107011_BPRNA_EpiDISH_modify_all_longly <- ggplot(melt_GSE107011_BPRNA_EpiDISH_modify_FACS,aes(x = FACS, y = ALL, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "BPRNA") + scale_x_continuous(name = NULL, limits = NULL) + scale_y_continuous(name = NULL, breaks = NULL, labels = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.95), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.29, y = 0.07, label = paste("R = ", round(cor.test(as.matrix(GSE107011_BPRNA_EpiDISH_modify), as.matrix(FACS_GSE107011[, c(1,2,4,3,5,6)]))$est,2)), parse = F, size = 8)

#### each cell types

GSE107011_BPRNA_EpiDISH_modify <- cbind(GSE107011_BPRNA_EpiDISH_modify, FACS_GSE107011[, c(1,2,4,3,5,6)]/100)

colnames(GSE107011_BPRNA_EpiDISH_modify) <- c("V","V","V","V","V","V", "CD4","CD8","Mono","B","NK", "Neu")


melt_GSE107011_BPRNA_EpiDISH_modify <- list()
rmse <- list()
melt_GSE107011_BPRNA_EpiDISH <- list()

for (i in c(1:6)) {
  
    rmse[[i]] <- rmse(GSE107011_BPRNA_EpiDISH_modify[,i], GSE107011_BPRNA_EpiDISH_modify[,i+6])
    
    melt_GSE107011_BPRNA_EpiDISH_modify[[i]] <- melt(GSE107011_BPRNA_EpiDISH_modify[,c(i, i+6)],  id.vars = colnames(GSE107011_BPRNA_EpiDISH_modify)[i], measure.vars = colnames(GSE107011_BPRNA_EpiDISH_modify)[i+6])
}

RMSE <- data.frame(cell_type = c("CD4", "CD8", "Mono", "B", "NK", "Neu"),
                   rmse = unlist(rmse))


melt_GSE107011_BPRNA_EpiDISH[[1]] <- ggplot(melt_GSE107011_BPRNA_EpiDISH_modify[[1]],aes(x=value, y= V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL,limits = c(0,0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.8)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.74, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.62, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.088, y = 0.52, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6)


melt_GSE107011_BPRNA_EpiDISH[[2]] <- ggplot(melt_GSE107011_BPRNA_EpiDISH_modify[[2]],aes(x=value, y= V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.15)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.14, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.117, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.068, y = 0.097, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

melt_GSE107011_BPRNA_EpiDISH[[3]] <- ggplot(melt_GSE107011_BPRNA_EpiDISH_modify[[3]],aes(x=value, y= V)) + geom_point(colour = c("blue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL,limits = c(0,0.4)) + scale_y_continuous(name = NULL, limits = c(0,0.5)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.475, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.405, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.088, y = 0.345, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)


melt_GSE107011_BPRNA_EpiDISH[[4]] <- ggplot(melt_GSE107011_BPRNA_EpiDISH_modify[[4]],aes(x=value, y= V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = NULL) + scale_y_continuous(name = NULL, limits = c(0,0.5)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.475, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.405, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.0345, y = 0.335, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)

melt_GSE107011_BPRNA_EpiDISH[[5]] <- ggplot(melt_GSE107011_BPRNA_EpiDISH_modify[[5]],aes(x=value, y= V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.2)) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.19, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.165, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.045, y = 0.14, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)

melt_GSE107011_BPRNA_EpiDISH[[6]] <- ggplot(melt_GSE107011_BPRNA_EpiDISH_modify[[6]],aes(x=value, y= V)) + geom_point(colour = c("deepskyblue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,0.04)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 18, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.038, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.033, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.018, y = 0.0275, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[6],2))))), parse = TRUE, size = 6)



# left = text_grob("BPRNA estimate", color = "black", size = 20, rot = 90),

```

############## Figure 4  #####################
```{r}

library(cowplot)
library(dplyr)


p_GSE107011_BPRNA_EpiDISH_each <- ggarrange(melt_GSE107011_BPRNA_EpiDISH[[1]],melt_GSE107011_BPRNA_EpiDISH[[2]],melt_GSE107011_BPRNA_EpiDISH[[3]],melt_GSE107011_BPRNA_EpiDISH[[4]],melt_GSE107011_BPRNA_EpiDISH[[5]], melt_GSE107011_BPRNA_EpiDISH[[6]], ncol = 2, nrow = 3)


figure_GSE107011_BPRNA_EpiDISH_together <- ggarrange(p_melt_GSE107011_BPRNA_EpiDISH_modify_all, p_GSE107011_BPRNA_EpiDISH_each, ncol = 2, labels = "a", nrow=1, font.label = list(size = 20, color = "black"), widths = c(1,2.5)) #, labels = "b"

Fig_4a <- annotate_figure(figure_GSE107011_BPRNA_EpiDISH_together,  bottom = text_grob("Gold standard", color = "black", size = 20), left = text_grob("BPRNA estimate", color = "black", size = 20, rot = 90))



# GSE107011_PBMCs <- read.table("~/paper1.txt", row.names = 1, header = T)
# GSE107011_PBMCs_pvalue <- read.table("~/paper1.txt", row.names = 1, header = T)

melt_PBMCs <- melt(GSE107011_PBMCs)
melt_PBMCs_Pvalue <- melt(GSE107011_PBMCs_pvalue)


merge_melt_PBMCs <- cbind(melt_PBMCs, melt_PBMCs_Pvalue) %>% .[,-3]


melt_merge_melt_PBMCs <- merge_melt_PBMCs %>%
    mutate(text = case_when(  # 一定要 get 到 case_when() 函数奥秘
        is.na(value.1) & is.na(value) ~ paste("NA", "\n"),
        is.na(value.1) & (value == 0) ~ paste(value, "\n"),
        value.1 >= 0.05 ~ paste(value, "\n"),
        value.1 >= 0.01& value.1 < 0.05  ~ paste(value, "\n*"), # round() 只保留两位小数
        value.1 >= 0.001 & value.1 < 0.01 ~ paste(value, "\n**"),
        value.1 < 0.001 ~ paste(value, "\n***")))

melt_merge_melt_PBMCs$new_Var2 <- rownames(GSE107011_PBMCs_pvalue)
melt_merge_melt_PBMCs$new_Var2 <- factor(melt_merge_melt_PBMCs$new_Var2, levels = unique(melt_merge_melt_PBMCs$new_Var2))

PBMCs_figure <- ggplot(melt_merge_melt_PBMCs, aes(new_Var2, variable)) + 
    geom_tile(aes(fill = value), colour = "grey", size = 1)+
    scale_fill_gradient2(low = "#5C5DAF",mid = "white",high = "#EA2E2D") + 
    
    geom_text(aes(label=text),col ="black",size = 8) +
    theme_minimal() + # 不要背景
    theme(axis.title.x=element_blank(), # 去掉 title
          axis.ticks.x=element_blank(), # 去掉x 轴
          axis.title.y=element_blank(), # 去掉 y 轴
          legend.title=element_text(size = 20),
          legend.text=element_text(size = 20),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 20, colour = "black"), # 调整x轴文字，字体加粗
          axis.text.y = element_text(size = 20, colour = "black")) + labs(fill =paste0("Correlation")) + ggtitle("Pearson correlation") + theme(plot.title = element_text(hjust = 0.5, size = 20 ))

Figure_4b <- ggarrange(PBMCs_figure, ncol = 1, labels = "b", nrow=1, font.label = list(size = 20, color = "black"))

# Figure_4 <- ggarrange(figure_GSE107011_BPRNA_EpiDISH_together ,PBMCs_figure, ncol = 1, nrow=2, font.label = list(size = 20, color = "black"))


# ggdraw()+ draw_plot(p_GSE107011_CCLE_TIL10_EpiDISH_modify_all, x=0, y=0.6, width=0.5, height = 0.4)+
#     draw_plot(p_melt_GSE107011_BPRNA_EpiDISH_modify_all, x=0.5, y= 0.6, width=0.5, height = 0.4) +
#     draw_plot(p_melt_GSE107011_BPRNACan_EpiDISH_modify_all, x=1, y=0.6, width = 0.5, height = 0.4)+ 
#     draw_plot(PBMCs_figure, x=0, y= 0, width = 1, height = 0.6)+ 
#     draw_plot_label(label = c("a", "b", "c", "d"), size = 18, x=c(0, 0.5, 1, 0), y=c(1, 1, 1, 0.58))
# 
# 
# ggdraw()+ draw_plot(figure_GSE107011_all_together, x = 0.05, y = 0.5, width = 0.9, height = 0.5)+
#     draw_plot(PBMCs_figure, x=0, y= 0, width = 1, height = 0.5) + 
#     draw_plot_label(label = c("a", "b"), size = 20, x = c(0.01, 0.01), y=c(1, 0.5))
#   
# 
# ggarrange(PBMCs_figure, labels = "b", nrow=1, ncol = 1, font.label = list(size = 20, color = "black"), widths = c(1,1))


```




######### Not Run ##### 

######### CCLE_TIL10 ###################

```{r}
library(dplyr)

GSE107011_CCLE_TIL10_EpiDISH_modify <- cbind((GSE107011_CCLE_TIL10_EpiDISH$T.cells.CD4 + GSE107011_CCLE_TIL10_EpiDISH$Tregs),GSE107011_CCLE_TIL10_EpiDISH[, c(9,5,2,7,6)])

colnames(GSE107011_CCLE_TIL10_EpiDISH_modify) <- c("CD4", "CD8", "Mono", "B", "NK", "Neu")

# melt_GSE107011_CCLE_TIL10_EpiDISH_modify <- melt(GSE107011_CCLE_TIL10_EpiDISH_modify)
# melt_FACS_GSE107011 <- melt(FACS_GSE107011[, c(1,2,4,3,5,6)]/100)

  melt_GSE107011_CCLE_TIL10_EpiDISH_modify_FACS <- melt(GSE107011_CCLE_TIL10_EpiDISH_modify) %>% cbind(melt_FACS_GSE107011$value, .)
  colnames(melt_GSE107011_CCLE_TIL10_EpiDISH_modify_FACS) <- c("FACS","cell_type","ALL")

p_GSE107011_CCLE_TIL10_EpiDISH_modify_all <- ggplot(melt_GSE107011_CCLE_TIL10_EpiDISH_modify_FACS,aes(x = FACS, y = ALL, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "ALL") + scale_x_continuous(name = NULL, limits = c(0,0.4)) + scale_y_continuous(name = "CCLE_TIL10 estimate", limits = c(0,0.6)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.95), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.3, y = 0, label = paste("R = ", round(cor.test(as.matrix(GSE107011_CCLE_TIL10_EpiDISH_modify), as.matrix(FACS_GSE107011[, c(1,2,4,3,5,6)]/100))$est,2)), parse = F, size = 8)

p_GSE107011_CCLE_TIL10_EpiDISH_modify_all_longly <- ggplot(melt_GSE107011_CCLE_TIL10_EpiDISH_modify_FACS,aes(x = FACS, y = ALL, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "CCLE_TIL10") + scale_x_continuous(name = NULL, limits = c(0,0.4)) + scale_y_continuous(name = NULL, limits = c(0,0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.95), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.3, y = 0.07, label = paste("R = ", round(cor.test(as.matrix(GSE107011_CCLE_TIL10_EpiDISH_modify), as.matrix(FACS_GSE107011[, c(1,2,4,3,5,6)]/100))$est,2)), parse = F, size = 8)


#### each cell types

GSE107011_CCLE_TIL10_EpiDISH_modify <- cbind(GSE107011_CCLE_TIL10_EpiDISH_modify, FACS_GSE107011[, c(1,2,4,3,5,6)]/100)

colnames(GSE107011_CCLE_TIL10_EpiDISH_modify) <- c("V","V","V","V","V","V", "CD4","CD8","Mono","B","NK", "Neu")


melt_GSE107011_CCLE_TIL10_EpiDISH_modify <- list()
rmse <- list()
melt_GSE107011_CCLE_TIL10_EpiDISH <- list()

for (i in c(1:6)) {
  
    rmse[[i]] <- rmse(GSE107011_CCLE_TIL10_EpiDISH_modify[,i], GSE107011_CCLE_TIL10_EpiDISH_modify[,i+6])
    
    melt_GSE107011_CCLE_TIL10_EpiDISH_modify[[i]] <- melt(GSE107011_CCLE_TIL10_EpiDISH_modify[,c(i, i+6)],  id.vars = colnames(GSE107011_CCLE_TIL10_EpiDISH_modify)[i], measure.vars = colnames(GSE107011_CCLE_TIL10_EpiDISH_modify)[i+6])
}

RMSE <- data.frame(cell_type = c("CD4", "CD8", "Mono", "B", "NK", "Neu"),
                   rmse = unlist(rmse))


melt_GSE107011_CCLE_TIL10_EpiDISH[[1]] <- ggplot(melt_GSE107011_CCLE_TIL10_EpiDISH_modify[[1]],aes(x=value, y= V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL,limits = c(0,0.4)) + scale_y_continuous(name = NULL, limits = c(0,0.5)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.5, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.455, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.105, y = 0.415, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6) 


melt_GSE107011_CCLE_TIL10_EpiDISH[[2]] <- ggplot(melt_GSE107011_CCLE_TIL10_EpiDISH_modify[[2]],aes(x=value, y= V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.3, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.273, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.08, y = 0.25, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

melt_GSE107011_CCLE_TIL10_EpiDISH[[3]] <- ggplot(melt_GSE107011_CCLE_TIL10_EpiDISH_modify[[3]],aes(x=value, y= V)) + geom_point(colour = c("blue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL,limits = c(0,0.4)) + scale_y_continuous(name = NULL, limits = c(0,0.5)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.5, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.455, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.092, y = 0.415, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)  
  

melt_GSE107011_CCLE_TIL10_EpiDISH[[4]] <- ggplot(melt_GSE107011_CCLE_TIL10_EpiDISH_modify[[4]],aes(x=value, y= V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.2)) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.182, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.055, y = 0.166, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)

melt_GSE107011_CCLE_TIL10_EpiDISH[[5]] <- ggplot(melt_GSE107011_CCLE_TIL10_EpiDISH_modify[[5]],aes(x=value, y= V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.2)) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.182, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.055, y = 0.166, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)

melt_GSE107011_CCLE_TIL10_EpiDISH[[6]] <- ggplot(melt_GSE107011_CCLE_TIL10_EpiDISH_modify[[6]],aes(x=value, y= V)) + geom_point(colour = c("deepskyblue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,0.08)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.08, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.0735, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.022, y = 0.0676, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[6],2))))), parse = TRUE, size = 6)

p_GSE107011_CCLE_TIL10_EpiDISH_each <- ggarrange(melt_GSE107011_CCLE_TIL10_EpiDISH[[1]],melt_GSE107011_CCLE_TIL10_EpiDISH[[2]],melt_GSE107011_CCLE_TIL10_EpiDISH[[3]],melt_GSE107011_CCLE_TIL10_EpiDISH[[4]],melt_GSE107011_CCLE_TIL10_EpiDISH[[5]], melt_GSE107011_CCLE_TIL10_EpiDISH[[6]], ncol = 3, nrow = 2)


figure_GSE107011_CCLE_TIL10_EpiDISH_each_together <- ggarrange(p_GSE107011_CCLE_TIL10_EpiDISH_modify_all, p_GSE107011_CCLE_TIL10_EpiDISH_each, ncol = 2, nrow=1, labels = "a", font.label = list(size = 20, color = "black"), widths = c(1,2))

figure_GSE107011_CCLE_TIL10_EpiDISH_each_together <- annotate_figure(figure_GSE107011_CCLE_TIL10_EpiDISH_each_together, left = text_grob("CCLE_TIL10 estimate", color = "black", size = 20, rot = 90))

```

############## BPRNACan ###################

```{r}
GSE107011_BPRNACan_EpiDISH_modify <- cbind(GSE107011_BPRNACan_EpiDISH[, c(3,4,8,1,10,9)])

# melt_GSE107011_BPRNACan_EpiDISH_modify <- melt(GSE107011_BPRNACan_EpiDISH_modify)
# melt_FACS_107 <- melt(FACS_GSE107011[, c(1,2,4,3,5,6)]/100)

melt_GSE107011_BPRNACan_EpiDISH_modify_FACS <- melt(GSE107011_BPRNACan_EpiDISH_modify) %>% cbind(melt_FACS_107$value, .)
colnames(melt_GSE107011_BPRNACan_EpiDISH_modify_FACS) <- c("FACS","cell_type","ALL")

p_melt_GSE107011_BPRNACan_EpiDISH_modify_all <- p_melt_GSE107011_BPRNACan_EpiDISH_modify_all <- ggplot(melt_GSE107011_BPRNACan_EpiDISH_modify_FACS,aes(x = FACS, y = ALL, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "ALL") + scale_x_continuous(name = NULL, limits = c(0,0.4)) + scale_y_continuous(name = "BPRNACan estimate", limits = c(0,0.6)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.95), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.3, y = 0, label = paste("R = ", round(cor.test(as.matrix(GSE107011_BPRNACan_EpiDISH_modify), as.matrix(FACS_GSE107011[, c(1,2,4,3,5,6)]/100))$est,2)), parse = F, size = 8)


p_melt_GSE107011_BPRNACan_EpiDISH_modify_all_longly <- ggplot(melt_GSE107011_BPRNACan_EpiDISH_modify_FACS,aes(x = FACS, y = ALL, colour = cell_type)) + geom_point(shape = 19 ,size=4) + theme_bw() + scale_color_manual(values = c("red", "green", "blue", "darkgoldenrod1", "darkmagenta", "deepskyblue")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "BPRNACan") + scale_x_continuous(name = NULL, limits = c(0,0.4)) + scale_y_continuous(name = "BPRNACan estimate", limits = c(0,0.6)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.95), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.25, y = 0, label = paste("R = ", round(cor.test(as.matrix(GSE107011_BPRNACan_EpiDISH_modify), as.matrix(FACS_GSE107011[, c(1,2,4,3,5,6)]/100))$est,2)), parse = F, size = 8)

#### each cell types

GSE107011_BPRNACan_EpiDISH_modify <- cbind(GSE107011_BPRNACan_EpiDISH_modify, FACS_GSE107011[, c(1,2,4,3,5,6)]/100)

colnames(GSE107011_BPRNACan_EpiDISH_modify) <- c("V","V","V","V","V","V", "CD4","CD8","Mono","B","NK", "Neu")


melt_GSE107011_BPRNACan_EpiDISH_modify <- list()
rmse <- list()
melt_GSE107011_BPRNACan_EpiDISH <- list()

for (i in c(1:6)) {
  
    rmse[[i]] <- rmse(GSE107011_BPRNACan_EpiDISH_modify[,i], GSE107011_BPRNACan_EpiDISH_modify[,i+6])
    
    melt_GSE107011_BPRNACan_EpiDISH_modify[[i]] <- melt(GSE107011_BPRNACan_EpiDISH_modify[,c(i, i+6)],  id.vars = colnames(GSE107011_BPRNACan_EpiDISH_modify)[i], measure.vars = colnames(GSE107011_BPRNACan_EpiDISH_modify)[i+6])
}

RMSE <- data.frame(cell_type = c("CD4", "CD8", "Mono", "B", "NK", "Neu"),
                   rmse = unlist(rmse))


melt_GSE107011_BPRNACan_EpiDISH[[1]] <- ggplot(melt_GSE107011_BPRNACan_EpiDISH_modify[[1]],aes(x=value, y= V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL,limits = c(0,0.4)) + scale_y_continuous(name = NULL, limits = c(0,0.5)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.5, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.455, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.105, y = 0.412, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6) 


melt_GSE107011_BPRNACan_EpiDISH[[2]] <- ggplot(melt_GSE107011_BPRNACan_EpiDISH_modify[[2]],aes(x=value, y= V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL, limits = c(0,0.15)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.15, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.138, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.0842, y = 0.125, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

melt_GSE107011_BPRNACan_EpiDISH[[3]] <- ggplot(melt_GSE107011_BPRNACan_EpiDISH_modify[[3]],aes(x=value, y= V)) + geom_point(colour = c("blue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL,limits = c(0,0.4)) + scale_y_continuous(name = NULL, limits = c(0,0.5)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.5, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.455, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.108, y = 0.412, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)  
  

melt_GSE107011_BPRNACan_EpiDISH[[4]] <- ggplot(melt_GSE107011_BPRNACan_EpiDISH_modify[[4]],aes(x=value, y= V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.2)) + scale_y_continuous(name = NULL, limits = c(0,0.3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.3, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.276, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.052, y = 0.25, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)

melt_GSE107011_BPRNACan_EpiDISH[[5]] <- ggplot(melt_GSE107011_BPRNACan_EpiDISH_modify[[5]],aes(x=value, y= V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.2)) + scale_y_continuous(name = NULL, limits = c(0,0.15)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.15, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.138, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.055, y = 0.125, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)

melt_GSE107011_BPRNACan_EpiDISH[[6]] <- ggplot(melt_GSE107011_BPRNACan_EpiDISH_modify[[6]],aes(x=value, y= V)) + geom_point(colour = c("deepskyblue"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,0.08)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.08, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.0735, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.022, y = 0.0673, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[6],2))))), parse = TRUE, size = 6)

p_GSE107011_BPRNACan_EpiDISH_each <- ggarrange(melt_GSE107011_BPRNACan_EpiDISH[[1]],melt_GSE107011_BPRNACan_EpiDISH[[2]],melt_GSE107011_BPRNACan_EpiDISH[[3]],melt_GSE107011_BPRNACan_EpiDISH[[4]],melt_GSE107011_BPRNACan_EpiDISH[[5]], melt_GSE107011_BPRNACan_EpiDISH[[6]], ncol = 3, nrow = 2)


figure_GSE107011_BPRNACan_EpiDISH_together <- ggarrange(p_melt_GSE107011_BPRNACan_EpiDISH_modify_all, p_GSE107011_BPRNACan_EpiDISH_each, ncol = 2, nrow=1, labels = "b", font.label = list(size = 20, color = "black"), widths = c(1,2))

figure_GSE107011_BPRNACan_EpiDISH_together <- annotate_figure(figure_GSE107011_BPRNACan_EpiDISH_together, left = text_grob("BPRNACan estimate", color = "black", size = 20, rot = 90), bottom = text_grob("Gold standard", color = "black", size = 20))



```

############## PBMC GSE107011  ###################

```{r}
figure_GSE107011_all_together <- ggarrange(p_GSE107011_CCLE_TIL10_EpiDISH_modify_all, p_melt_GSE107011_BPRNA_EpiDISH_modify_all, p_melt_GSE107011_BPRNACan_EpiDISH_modify_all, ncol = 3, nrow=1, font.label = list(size = 20, color = "black"))

figure_GSE107011_all_together <- annotate_figure(figure_GSE107011_all_together, bottom = text_grob("Gold standard", color = "black", size = 20))
```

######### Not Run #####



############################ Start Figure S4 ############################ 

############################ 1700 in-silico mixture RNAseq benchmark ############################ 

############################ CCLE_TIL10 ############################ 

```{r}

load("/home/ting/deconvolution/Final methylation paper/figure/Figure_S4/Silico_1700_RNAseq.RData")

out.l <- epidish(Silico_1700, CCLE_TIL10, "RPC", maxit = 200)
benchmarker_CCLE_TIL10 <- data.frame(out.l$estF[,c(1,8,9,5,3,4,2,7,6,10,11)])
benchmarker_CCLE_TIL10 <- cbind(benchmarker_CCLE_TIL10, Facs_Silico_1700)

colnames(benchmarker_CCLE_TIL10)<-c("V","V","V","V","V","V","V","V","V","V","V","Cancer","CD4","CD8","Mono","M1","M2","B","NK", "Neu", "Tregs", "DCs")

melt_benchmarker_CCLE_TIL10 <- list()
rmse <- list()
p_benchmarker_CCLE_TIL10 <- list()


for (i in c(1:11)) {
    
    rmse <- rmse(benchmarker_CCLE_TIL10[,i], Facs_Silico_1700[,i])
    melt_benchmarker_CCLE_TIL10[[i]] <- melt(benchmarker_CCLE_TIL10[,c(i, i+11)],  id.vars = colnames(benchmarker_CCLE_TIL10)[i], measure.vars = colnames(benchmarker_CCLE_TIL10)[i+11])
    



RMSE <- data.frame(cell_type = c("Cancer","CD4","CD8","Mono","M1","M2","B","NK", "Neu", "Tregs", "DCs"),
                   rmse = unlist(rmse))

p_benchmarker_CCLE_TIL10[[i]] <- ggplot(melt_benchmarker_CCLE_TIL10[[i]],aes(x=value, y= V)) + geom_point(colour = c("cyan1", "red", "green", "blue", "darkorange1","deeppink","darkgoldenrod1", "darkmagenta", "deepskyblue", "darkgreen", "midnightblue")[i]) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL,limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.915, size = 6) + annotate("text", x = 0.22, y = 0.832, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6)  
}

for (i in c(2:11)) {
    
    rmse <- rmse(benchmarker_CCLE_TIL10[,i], Facs_Silico_1700[,i])
    melt_benchmarker_CCLE_TIL10[[i]] <- melt(benchmarker_CCLE_TIL10[,c(i, i+11)],  id.vars = colnames(benchmarker_CCLE_TIL10)[i], measure.vars = colnames(benchmarker_CCLE_TIL10)[i+11])
    
    RMSE <- data.frame(cell_type = c("Cancer","CD4","CD8","Mono","M1","M2","B","NK", "Neu", "Tregs", "DCs"),
                   rmse = unlist(rmse))
    
p_benchmarker_CCLE_TIL10[[i]] <- ggplot(melt_benchmarker_CCLE_TIL10[[i]],aes(x=value, y= V)) + geom_point(colour = c("cyan1", "red", "green", "blue", "darkorange1","deeppink","darkgoldenrod1", "darkmagenta", "deepskyblue", "darkgreen", "midnightblue")[i]) + theme_bw() + stat_smooth(method = lm, color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL,limits = c(0,0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.37, size = 6) + annotate("text", x = 0.062, y = 0.335, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6) +  theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) 
}

```

############################ BPRNACan ############################ 

```{r}

out.l <- epidish(Silico_1700, BPRNACan, "RPC", maxit = 200)
benchmarker_BPRNACan_150 <- data.frame(out.l$estF[,c(2,3,4,8,6,7,1,10,9)])
benchmarker_BPRNACan_150 <- cbind(benchmarker_BPRNACan_150, Facs_Silico_1700[,-c(10,11)])

colnames(benchmarker_BPRNACan_150)<-c("V","V","V","V","V","V","V","V", "V","Cancer","CD4","CD8","Mono","M1","M2","B","NK", "Neu")

melt_benchmarker_BPRNACan_150 <- list()
rmse <- list()
bench_BPRNACan <- list()

for (i in c(1:9)) {
  
    rmse[[i]] <- rmse(benchmarker_BPRNACan_150[,i], benchmarker_BPRNACan_150[,i+9])
    
    melt_benchmarker_BPRNACan_150[[i]] <- melt(benchmarker_BPRNACan_150[,c(i, i+9)],  id.vars = colnames(benchmarker_BPRNACan_150)[i], measure.vars = colnames(benchmarker_BPRNACan_150)[i+9])
}

RMSE <- data.frame(cell_type = c("Cancer","CD4","CD8","Mono","M1","M2","B","NK", "Neu"),
                   rmse = unlist(rmse))


bench_BPRNACan[[1]] <- ggplot(melt_benchmarker_BPRNACan_150[[1]],aes(x=value, y= V)) + geom_point(colour = c("cyan1")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.935, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.22, y = 0.865, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6)


bench_BPRNACan[[2]] <- ggplot(melt_benchmarker_BPRNACan_150[[2]],aes(x=value, y= V)) + geom_point(colour = c("red")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.37, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text",  x = 0.062, y = 0.342, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)


bench_BPRNACan[[3]] <- ggplot(melt_benchmarker_BPRNACan_150[[3]],aes(x=value, y= V)) + geom_point(colour = c("green")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.185, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.066, y = 0.17, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)

bench_BPRNACan[[4]] <- ggplot(melt_benchmarker_BPRNACan_150[[4]],aes(x=value, y= V)) + geom_point(colour = c("blue")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.37, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.062, y = 0.342, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)

bench_BPRNACan[[5]] <- ggplot(melt_benchmarker_BPRNACan_150[[5]],aes(x=value, y= V)) + geom_point(colour = c("darkorange1")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.04, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.037, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.065, y = 0.034, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)

bench_BPRNACan[[6]] <- ggplot(melt_benchmarker_BPRNACan_150[[6]],aes(x=value, y= V)) + geom_point(colour = c("deeppink")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.4)) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 4e-04, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 3.7e-04, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.092, y = 3.4e-04, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[6],2))))), parse = TRUE, size = 6)

bench_BPRNACan[[7]] <- ggplot(melt_benchmarker_BPRNACan_150[[7]],aes(x=value, y= V)) + geom_point(colour = c("darkgoldenrod1")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.37, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.062, y = 0.342, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[7],2))))), parse = TRUE, size = 6)

bench_BPRNACan[[8]] <- ggplot(melt_benchmarker_BPRNACan_150[[8]],aes(x=value, y= V)) + geom_point(colour = c("darkmagenta")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3)) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.185, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.066, y = 0.17, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[8],2))))), parse = TRUE, size = 6)

bench_BPRNACan[[9]] <- ggplot(melt_benchmarker_BPRNACan_150[[9]],aes(x=value, y= V)) + geom_point(colour = c("deepskyblue")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.3) ) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.37, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.062, y = 0.342, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[9],2))))), parse = TRUE, size = 6)


```





################# Figure 4S #######################

```{r}

Figure_4Sa <- ggarrange(p_benchmarker_CCLE_TIL10[[1]], p_benchmarker_CCLE_TIL10[[2]], p_benchmarker_CCLE_TIL10[[3]], p_benchmarker_CCLE_TIL10[[4]], p_benchmarker_CCLE_TIL10[[5]], p_benchmarker_CCLE_TIL10[[6]], p_benchmarker_CCLE_TIL10[[7]], p_benchmarker_CCLE_TIL10[[8]], p_benchmarker_CCLE_TIL10[[9]], p_benchmarker_CCLE_TIL10[[10]], p_benchmarker_CCLE_TIL10[[11]], ncol = 3, nrow=4, labels = "a", font.label = list(size = 18, color = "black"))

Figure_4Sa <- annotate_figure(Figure_4Sa,
                bottom = text_grob("Gold standard", color = "black", size = 20),
                left = text_grob("CCLE_TIL10 estimate", color = "black", size = 20, rot = 90))


Figure_S4b <- ggarrange(bench_BPRNACan[[1]],bench_BPRNACan[[2]],bench_BPRNACan[[3]],bench_BPRNACan[[4]],bench_BPRNACan[[5]],bench_BPRNACan[[6]],bench_BPRNACan[[7]],bench_BPRNACan[[8]],bench_BPRNACan[[9]], ncol = 3, nrow=3,labels = "b", font.label = list(size = 18, color = "black"))

Figure_S4b <- annotate_figure(Figure_S4b,
                bottom = text_grob("Gold standard", color = "black", size = 20),
                left = text_grob("BPRNACan estimate", color = "black", size = 20, rot = 90))


```




############################ Start Figure 5 ############################ 

#############  H&E #####################

############## CCLE_TIL10 #####################

# Lymphocytes: CD4 + CD8 + B + NK + Tregs

# Monocytes/Macrophages lineage: Monocytes + M1 + M2

# Neutrophiles: Neutrophils

```{r}

load("/home/ting/deconvolution/Final methylation paper/figure/figure5/Figure_5.RData")

library(reshape2)
library(scales)
library(ggpubr)
library(EpiDISH)

out.l <- epidish(LUAD_RNAseq_TPM, CCLE_TIL10, "RPC", maxit = 100)
TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv <- data.frame(out.l$estF)
TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv <- TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv[sort(rownames(TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv)),]
TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv <- TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv[rownames(TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv) %in% rownames(HE_TCGA_LUAD_lymphocytes_modify),]

TCGA_LUAD_CCLE_TIL10_lymphocytes <- cbind((TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv$B + TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv$CD4 + TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv$CD8 + TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv$NK + TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv$Tregs), HE_TCGA_LUAD_lymphocytes_modify$Lymphocytes)
colnames(TCGA_LUAD_CCLE_TIL10_lymphocytes) <- c("estimate", "facs")

TCGA_LUAD_CCLE_TIL10_Macrophages <- cbind((TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv$M1 + TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv$M2 + TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv$Mono), HE_TCGA_LUAD_lymphocytes_modify$Macrophages)
colnames(TCGA_LUAD_CCLE_TIL10_Macrophages) <- c("estimate", "facs")

TCGA_LUAD_CCLE_TIL10_Neutrophils <- cbind((TCGA_LUAD_CCLE_TIL10_lymphocytes_deconv$Neu), HE_TCGA_LUAD_lymphocytes_modify$Neutrophils)
colnames(TCGA_LUAD_CCLE_TIL10_Neutrophils) <- c("estimate", "facs")

p_TCGA_LUAD_CCLE_TIL10_lymphocytes <- ggplot(as.data.frame(TCGA_LUAD_CCLE_TIL10_lymphocytes),aes(x = facs, y= estimate)) + geom_point(colour = c("darkslategrey")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "Lymphocytes")+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.5, size = 6) + stat_cor(aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.46, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5))

p_TCGA_LUAD_CCLE_TIL10_Macrophages <- ggplot(as.data.frame(TCGA_LUAD_CCLE_TIL10_Macrophages),aes(x=estimate, y= facs)) + geom_point(colour = c("coral")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "Macrophages")+ scale_x_continuous(name = NULL, limits = c(0,0.8)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.37, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) 

p_TCGA_LUAD_CCLE_TIL10_Neutrophils <- ggplot(as.data.frame(TCGA_LUAD_CCLE_TIL10_Neutrophils),aes(x = facs, y = estimate )) + geom_point(colour = c("deepskyblue")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "Neutrophils")+ scale_x_continuous(name = NULL, limits = c(0,0.03)) + scale_y_continuous(name = NULL, limits = c(0,0.05)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.05, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.046, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5))

figure_TCGA_LUAD_CCLE_TIL10 <- ggarrange(p_TCGA_LUAD_CCLE_TIL10_lymphocytes, p_TCGA_LUAD_CCLE_TIL10_Macrophages, p_TCGA_LUAD_CCLE_TIL10_Neutrophils, ncol = 3, nrow=1)

annotate_figure_TCGA_LUAD_CCLE_TIL10 <- annotate_figure(figure_TCGA_LUAD_CCLE_TIL10, left = text_grob("CCLE_TIL10 estimate", color = "black", size = 20, rot = 90))


```

############## BPRNACan #####################

# Lymphocytes: CD4 + CD8 + B + NK

# Monocytes/Macrophages lineage: Monocytes + M0 + M1 + M2

# Neutrophiles: Neutrophils

```{r}

library(reshape2)
library(scales)
library(ggpubr)
library(EpiDISH)

out.l <- epidish(LUAD_RNAseq_TPM, BPRNACan, "RPC", maxit = 100)
TCGA_LUAD_BPRNACan_lymphocytes_deconv <- data.frame(out.l$estF)
TCGA_LUAD_BPRNACan_lymphocytes_deconv <- TCGA_LUAD_BPRNACan_lymphocytes_deconv[sort(rownames(TCGA_LUAD_BPRNACan_lymphocytes_deconv)),]
TCGA_LUAD_BPRNACan_lymphocytes_deconv <- TCGA_LUAD_BPRNACan_lymphocytes_deconv[rownames(TCGA_LUAD_BPRNACan_lymphocytes_deconv) %in% rownames(HE_TCGA_LUAD_lymphocytes_modify),]

TCGA_LUAD_BPRNACan_lymphocytes <- cbind((TCGA_LUAD_BPRNACan_lymphocytes_deconv$B + TCGA_LUAD_BPRNACan_lymphocytes_deconv$CD4 + TCGA_LUAD_BPRNACan_lymphocytes_deconv$CD8 + TCGA_LUAD_BPRNACan_lymphocytes_deconv$NK), HE_TCGA_LUAD_lymphocytes_modify$Lymphocytes)
colnames(TCGA_LUAD_BPRNACan_lymphocytes) <- c("estimate", "facs")

TCGA_LUAD_BPRNACan_Macrophages <- cbind((TCGA_LUAD_BPRNACan_lymphocytes_deconv$M0 + TCGA_LUAD_BPRNACan_lymphocytes_deconv$M1 + TCGA_LUAD_BPRNACan_lymphocytes_deconv$M2 + TCGA_LUAD_BPRNACan_lymphocytes_deconv$Mono), HE_TCGA_LUAD_lymphocytes_modify$Macrophages)
colnames(TCGA_LUAD_BPRNACan_Macrophages) <- c("estimate", "facs")

TCGA_LUAD_BPRNACan_Macrophages_NoM0 <- cbind((TCGA_LUAD_BPRNACan_lymphocytes_deconv$M1 + TCGA_LUAD_BPRNACan_lymphocytes_deconv$M2 + TCGA_LUAD_BPRNACan_lymphocytes_deconv$Mono), HE_TCGA_LUAD_lymphocytes_modify$Macrophages)
colnames(TCGA_LUAD_BPRNACan_Macrophages_NoM0) <- c("estimate", "facs")

TCGA_LUAD_BPRNACan_Macrophages_Only_Mono <- cbind((TCGA_LUAD_BPRNACan_lymphocytes_deconv$Mono), HE_TCGA_LUAD_lymphocytes_modify$Macrophages)
colnames(TCGA_LUAD_BPRNACan_Macrophages_Only_Mono) <- c("estimate", "facs")

TCGA_LUAD_BPRNACan_Macrophages_M1_m2 <- cbind((TCGA_LUAD_BPRNACan_lymphocytes_deconv$M1 + TCGA_LUAD_BPRNACan_lymphocytes_deconv$M2), HE_TCGA_LUAD_lymphocytes_modify$Macrophages)
colnames(TCGA_LUAD_BPRNACan_Macrophages_M1_m2) <- c("estimate", "facs")



TCGA_LUAD_BPRNACan_Neutrophils <- cbind((TCGA_LUAD_BPRNACan_lymphocytes_deconv$Neu), HE_TCGA_LUAD_lymphocytes_modify$Neutrophils)
colnames(TCGA_LUAD_BPRNACan_Neutrophils) <- c("estimate", "facs")



p_TCGA_LUAD_BPRNACan_lymphocytes <- ggplot(as.data.frame(TCGA_LUAD_BPRNACan_lymphocytes),aes(x = facs, y= estimate)) + geom_point(colour = c("darkslategrey")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "Lymphocytes")+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.08, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.073, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5))

p_TCGA_LUAD_BPRNACan_Macrophages <- ggplot(as.data.frame(TCGA_LUAD_BPRNACan_Macrophages),aes(x=estimate, y= facs)) + geom_point(colour = c("coral")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "Macrophages")+ scale_x_continuous(name = NULL, limits = c(0,0.05)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.37, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) 

p_TCGA_LUAD_BPRNACan_Neutrophils <- ggplot(as.data.frame(TCGA_LUAD_BPRNACan_Neutrophils),aes(x = facs, y = estimate )) + geom_point(colour = c("deepskyblue")) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "Neutrophils")+ scale_x_continuous(name = NULL, limits = c(0,0.03)) + scale_y_continuous(name = NULL, limits = c(0,0.008)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.008, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.0074, size = 6)  + theme(axis.title.y = element_text(vjust=1.5)) +  theme(axis.title.x = element_text(vjust=-0.5))

figure_TCGA_LUAD_BPRNACan <- ggarrange(p_TCGA_LUAD_BPRNACan_lymphocytes, p_TCGA_LUAD_BPRNACan_Macrophages, p_TCGA_LUAD_BPRNACan_Neutrophils, ncol = 3, nrow=1,  font.label = list(size = 20, color = "black"))

annotate_figure_TCGA_LUAD_BPRNACan <- annotate_figure(figure_TCGA_LUAD_BPRNACan, left = text_grob("BPRNACan estimate", color = "black", size = 20, rot = 90))



annotate_TCGA_LUAD_CCLE_TIL10_BPRNACan <- ggarrange(annotate_figure_TCGA_LUAD_CCLE_TIL10, annotate_figure_TCGA_LUAD_BPRNACan, ncol = 1, nrow=2, labels = "a", font.label = list(size = 20, color = "black"))

annotate_TCGA_LUAD_CCLE_TIL10_BPRNACan <- annotate_figure(annotate_TCGA_LUAD_CCLE_TIL10_BPRNACan, bottom = text_grob("H&E estimate", color = "black", size = 20))

```

##########  RNAseq Ludo's data 59 multiple myeloma TME patients ############

############## BPRNACan ###################

```{r}

out.l <- epidish(Thomas_RNAseq_part, BPRNACan, "RPC", maxit = 100)
Thomas_RNAseq_BPRNACan_150 <- data.frame(out.l$estF[,c(3,4,10)])

FACS_Thomas_mean_M <- FACS_Thomas_mean[,c(3,4,2)]/100

Thomas_RNAseq_BPRNACan_150 <- cbind(Thomas_RNAseq_BPRNACan_150, FACS_Thomas_mean_M)
colnames(Thomas_RNAseq_BPRNACan_150)<-c("V","V","V","CD4","CD8","NK")

melt_Thomas_RNAseq_BPRNACan_150 <- list()
rmse <- list()
Th <- list()

for (i in c(1:3)) {
  
    rmse[[i]] <- rmse(Thomas_RNAseq_BPRNACan_150[,i], FACS_Thomas_mean_M[,i])
    
    melt_Thomas_RNAseq_BPRNACan_150[[i]] <- melt(Thomas_RNAseq_BPRNACan_150[,c(i, i+3)],  id.vars = colnames(Thomas_RNAseq_BPRNACan_150)[i], measure.vars = colnames(Thomas_RNAseq_BPRNACan_150)[i+3])
}

RMSE <- data.frame(cell_type = c("CD4", "CD8",  "NK"),
                   rmse = unlist(rmse))


Th[[1]] <- ggplot(melt_Thomas_RNAseq_BPRNACan_150[[1]], aes(x=value, y= V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "CD4")+ scale_x_continuous(name = NULL, limits = c(0,0.18)) + scale_y_continuous(name = NULL, limits = c(0,0.25)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.25, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.235, size = 6)  +  theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) + annotate("text", x = 0.048, y = 0.22, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6)   

Th[[2]] <- ggplot(melt_Thomas_RNAseq_BPRNACan_150[[2]][-9,],aes(x=value, y= V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ "CD8")+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL, limits = c(0,0.05)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.05, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.047, size = 6)  +  theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) + annotate("text", x = 0.023, y = 0.044, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)
  
Th[[3]] <- ggplot(melt_Thomas_RNAseq_BPRNACan_150[[3]],aes(x=value, y= V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,0.04)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.04, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.0375, size = 6) +  theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) + annotate("text", x = 0.022, y = 0.035, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

```

############## quanTIseq ###################

```{r}
library(immunedeconv)
library(textshape)
library(dplyr)

Thomas_quantiseq = deconvolute(Thomas_RNAseq_part, "quantiseq", tumor = FALSE)
          
          Thomas_quantiseq <- as.data.frame(t(column_to_rownames(Thomas_quantiseq)))
          
          colnames(Thomas_quantiseq) <- c("B", "M1", "M2", "Mono", "Neu", "NK", "CD4", "CD8", "Tregs", "DCs", "UnCharcs")

Thomas_quanTIseq_M <- Thomas_quantiseq[,c(7,8,6)]

Thomas_quanTIseq_M <- cbind(Thomas_quanTIseq_M, FACS_Thomas_mean_M)
colnames(Thomas_quanTIseq_M)<-c("V","V","V","CD4","CD8","NK")

melt_Thomas_quanTIseq_M <- list()
rmse <- list()
Thq <- list()

for (i in c(1:3)) {
  
    rmse[[i]] <- rmse(Thomas_quanTIseq_M[,i], FACS_Thomas_mean_M[,i])
    
    melt_Thomas_quanTIseq_M[[i]] <- melt(Thomas_quanTIseq_M[,c(i, i+3)],  id.vars = colnames(Thomas_quanTIseq_M)[i], measure.vars = colnames(Thomas_quanTIseq_M)[i+3])
}


RMSE <- data.frame(cell_type = c("CD4", "CD8",  "NK"),
                   rmse = unlist(rmse))

Thq[[1]] <- ggplot(melt_Thomas_quanTIseq_M[[1]], aes(x=value, y= V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.2)) + scale_y_continuous(name = NULL, limits = c(0,0.12)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.12, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.112, size = 6)  +  theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) + annotate("text", x = 0.058, y = 0.105, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6)


Thq[[2]] <- ggplot(melt_Thomas_quanTIseq_M[[2]],aes(x=value, y= V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL, limits = c(0,0.08)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.08, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.075, size = 6) +  theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) + annotate("text", x = 0.023, y = 0.0705, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

Thq[[3]] <-  ggplot(melt_Thomas_quanTIseq_M[[3]],aes(x=value, y= V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,0.08)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.08, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.075, size = 6) +  theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) + annotate("text", x = 0.022, y = 0.0705, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)

 # Mix_figure_BPRNACan_quanTIseq_M <- ggarrange(figure_Thomas_BPRNACan_150, figure_Thomas_quanTIseq_M, ncol = 1, nrow=2)
 # annotate_figure(Mix_figure_BPRNACan_quanTIseq_M,
 #                 bottom = text_grob("Gold standard", color = "black", size = 20))
```

######################### MCP-counter ######################################

```{r}
Thomas_MCP_counter = deconvolute(Thomas_RNAseq_part, "mcp_counter")

Thomas_MCP_counter <- as.data.frame(t(column_to_rownames(Thomas_MCP_counter)))

Thomas_MCP_counter <- Thomas_MCP_counter[,-6]

colnames(Thomas_MCP_counter) <- c("T", "CD8", "CytotoxicityScore", "NK", "B", "Macrophage/Monocyte", "DCs", "Neu", "Endothelial", "CAFs")


Thomas_Thomas_MCP_counter_M <- Thomas_MCP_counter[,c(1,2,4)]
Thomas_Thomas_MCP_counter_M <- cbind((Thomas_Thomas_MCP_counter_M[,1]-Thomas_Thomas_MCP_counter_M[,2]),Thomas_Thomas_MCP_counter_M[,2], Thomas_Thomas_MCP_counter_M[,3])
Thomas_Thomas_MCP_counter_M <- pmax(Thomas_Thomas_MCP_counter_M, 0)

Thomas_Thomas_MCP_counter_M <- cbind(Thomas_Thomas_MCP_counter_M, FACS_Thomas_mean_M)
colnames(Thomas_Thomas_MCP_counter_M)<-c("V","V","V","CD4","CD8","NK")

melt_Thomas_Thomas_MCP_counter_M <- list()
rmse <- list()
Thm <- list()

for (i in c(1:3)) {
  
#     rmse[[i]] <- rmse(Thomas_Thomas_MCP_counter_M[,i], Thomas_Thomas_MCP_counter_M[,i+3])
#     
#     melt_Thomas_Thomas_MCP_counter_M[[i]] <- melt(Thomas_Thomas_MCP_counter_M[,c(i, i+3)],  id.vars = colnames(Thomas_Thomas_MCP_counter_M)[i], measure.vars = colnames(Thomas_Thomas_MCP_counter_M)[i+3])
# }

 rmse[[i]] <- rmse(Thomas_Thomas_MCP_counter_M[,i], FACS_Thomas_mean_M[,i])
    
    melt_Thomas_Thomas_MCP_counter_M[[i]] <- melt(Thomas_Thomas_MCP_counter_M[,c(i, i+3)],  id.vars = colnames(Thomas_Thomas_MCP_counter_M)[i], measure.vars = colnames(Thomas_Thomas_MCP_counter_M)[i+3])
}

RMSE <- data.frame(cell_type = c("CD4", "CD8",  "NK"),
                   rmse = unlist(rmse))

Thm[[1]] <- ggplot(melt_Thomas_Thomas_MCP_counter_M[[1]], aes(x=value, y= V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.2)) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 30, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 27.5, size = 6)  +  theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) + annotate("text", x = 0.051, y = 25.5, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6)


Thm[[2]] <- ggplot(melt_Thomas_Thomas_MCP_counter_M[[2]],aes(x=value, y= V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 50, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 46, size = 6) +  theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) + annotate("text", x = 0.024, y = 43, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

Thm[[3]] <-  ggplot(melt_Thomas_Thomas_MCP_counter_M[[3]],aes(x=value, y= V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable)+ scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,6)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 6, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 5.55, size = 6) +  theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) + annotate("text", x = 0.022, y = 5.15, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

```


############## scRNAseq GSE72056  ###################

############## BPRNACan ###################

```{r}
library(Metrics)

load("/home/ting/deconvolution/Final methylation paper/RNAseq/melanoma_scRNAseq_GSE72056_and_GSE93722/Two_datasets/Melanoma_GSE72056_RNAseq.RData")

out.l <- epidish(Melanoma_GSE72056_no_malighant, BPRNACan, "RPC", maxit = 100)
GSE72056_BPRNACan <- data.frame(cbind(out.l$estF[,2:4], out.l$estF[,5] + out.l$estF[,6]+out.l$estF[,7]+out.l$estF[,8],out.l$estF[,1],out.l$estF[,10])) 
colnames(GSE72056_BPRNACan)[4:6] <- c("Macrophages","B","NK")

GSE72056_BPRNACan_EpiDISH <- cbind(GSE72056_BPRNACan, Facs_Melanoma_GSE72056[,c(10,3,4,6,1,7)])

colnames(GSE72056_BPRNACan_EpiDISH) <- c("V","V","V","V","V","V", "cancer", "CD4", "CD8", "Macrophages", "B", "NK")


melt_GSE72056_BPRNACan_EpiDISH <- list()
rmse <- list()
p_GSE72056_BPRNACan_EpiDISH <- list()

for (i in c(1:6)) {
  
    rmse[[i]] <- rmse(GSE72056_BPRNACan_EpiDISH[,i], GSE72056_BPRNACan_EpiDISH[,i + 6])
    
    melt_GSE72056_BPRNACan_EpiDISH[[i]] <- melt(GSE72056_BPRNACan_EpiDISH[,c(i, i + 6)],  id.vars = colnames(GSE72056_BPRNACan_EpiDISH)[i], measure.vars = colnames(GSE72056_BPRNACan_EpiDISH)[i + 6])
}

RMSE <- data.frame(cell_type = c("cancer", "CD4", "CD8", "Macrophages", "B", "NK"),
                   rmse = unlist(rmse))

p_GSE72056_BPRNACan_EpiDISH[[1]] <- ggplot(melt_GSE72056_BPRNACan_EpiDISH[[1]],aes(x = value, y = V)) + geom_point(colour = c("cyan1"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.93, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.21, y = 0.87, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6) 

p_GSE72056_BPRNACan_EpiDISH[[2]] <- ggplot(melt_GSE72056_BPRNACan_EpiDISH[[2]],aes(x = value, y = V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.8)) + scale_y_continuous(name = NULL, limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.93, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.172, y = 0.87, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6) 

p_GSE72056_BPRNACan_EpiDISH[[3]] <- ggplot(melt_GSE72056_BPRNACan_EpiDISH[[3]],aes(x = value, y = V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.93, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.21, y = 0.87, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)

p_GSE72056_BPRNACan_EpiDISH[[4]] <- ggplot(melt_GSE72056_BPRNACan_EpiDISH[[4]],aes(x = value, y = V)) + geom_point(colour = c("coral"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.15)) + scale_y_continuous(name = NULL, limits = c(0,0.1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.093, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.0335, y = 0.087, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)

p_GSE72056_BPRNACan_EpiDISH[[5]] <- ggplot(melt_GSE72056_BPRNACan_EpiDISH[[5]],aes(x = value, y = V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.5)) + scale_y_continuous(name = NULL, limits = c(0,0.8)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.8, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.75, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.103, y = 0.7, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)

p_GSE72056_BPRNACan_EpiDISH[[6]] <- ggplot(melt_GSE72056_BPRNACan_EpiDISH[[6]],aes(x = value, y = V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,0.015)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.015, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.014, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.0185, y = 0.013, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[6],2))))), parse = TRUE, size = 6)

# figure_GSE72056_BPRNACan_EpiDISH <- ggarrange(p_GSE72056_BPRNACan_EpiDISH[[1]], p_GSE72056_BPRNACan_EpiDISH[[2]], p_GSE72056_BPRNACan_EpiDISH[[3]], p_GSE72056_BPRNACan_EpiDISH[[4]], p_GSE72056_BPRNACan_EpiDISH[[5]], p_GSE72056_BPRNACan_EpiDISH[[6]], ncol = 3, nrow = 2, labels = "c", font.label = list(size = 20, color = "black"))
# 
# figure_GSE72056_BPRNACan_EpiDISH <- annotate_figure(figure_GSE72056_BPRNACan_EpiDISH, left = text_grob("BPRNACan estimate", color = "black", size = 20, rot = 90), bottom = text_grob("Ture cell fractions", color = "black", size = 20))


# 
# 
# 
# 
# # melt_CCLE_TIL10_mel_non_malighant_M <- melt(CCLE_TIL10_mel_non_malighant_M)
# melt_FACS_GSE72056_CCLE_TIL10 <- melt(FACS_GSE72056_CCLE_TIL10)
# 
# melt_CCLE_TIL10_mel_non_malighant_M_FACS <- melt(CCLE_TIL10_mel_non_malighant_M) %>% cbind(melt_FACS_GSE72056_CCLE_TIL10$value, .)
# colnames(melt_CCLE_TIL10_mel_non_malighant_M_FACS) <- c("FACS","samples","cell_type","ALL")
# 
# p_CCLE_TIL10_mel_non_malighant_M_all <- ggplot(melt_CCLE_TIL10_mel_non_malighant_M_FACS,aes(x = FACS, y = ALL, colour = cell_type)) + geom_point(shape = 19 ,size=3) + theme_bw() + scale_color_manual(values = c("cyan1", "red", "green", "darkorange1","deeppink", "blue", "lightsalmon2","coral", "darkgoldenrod1", "darkmagenta", "darkgreen")) + stat_smooth(method = lm,color="black") + facet_wrap(~ "ALL") + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black")  + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + theme(legend.justification=c(0.05,0.95), legend.position=c(0.05,0.95), legend.title=element_blank(), legend.key.size = unit(0.8, "cm"))  + annotate("text", x = 0.4, y = 0.07, label = paste("R = ", round(cor.test(CCLE_TIL10_mel_non_malighant_M, as.matrix(FACS_GSE72056_CCLE_TIL10))$est,2)), parse = F, size = 8)

```

############## quanTIseq ###################

```{r}
library(immunedeconv)
library(textshape)

GSE72056_quanTIseq = deconvolute(Melanoma_GSE72056_no_malighant, "quantiseq", tumor = TRUE)
GSE72056_quanTIseq_TIL10 <- as.data.frame(t(column_to_rownames(GSE72056_quanTIseq,"cell_type")))
GSE72056_quanTIseq_TIL10 <- cbind(GSE72056_quanTIseq_TIL10[,7], GSE72056_quanTIseq_TIL10[,8], GSE72056_quanTIseq_TIL10[,2] + GSE72056_quanTIseq_TIL10[,3] + GSE72056_quanTIseq_TIL10[,4], GSE72056_quanTIseq_TIL10[,1], GSE72056_quanTIseq_TIL10[,6],GSE72056_quanTIseq_TIL10[,9])
colnames(GSE72056_quanTIseq_TIL10) <- c("CD4","CD8","Macrophages","B","NK","Tregs")

GSE72056_quanTIseq_TIL10 <- cbind(GSE72056_quanTIseq_TIL10, Facs_Melanoma_GSE72056[,c(3,4,6,1,7,9)])

colnames(GSE72056_quanTIseq_TIL10) <- c("V","V","V","V","V","V",  "CD4", "CD8", "Macrophages", "B", "NK", "Tregs")


melt_GSE72056_quanTIseq <- list()
rmse <- list()
p_GSE72056_quanTIseq <- list()

for (i in c(1:6)) {
  
    rmse[[i]] <- rmse(GSE72056_quanTIseq_TIL10[,i], GSE72056_quanTIseq_TIL10[,i + 6])
    
    melt_GSE72056_quanTIseq[[i]] <- melt(GSE72056_quanTIseq_TIL10[,c(i, i + 6)],  id.vars = colnames(GSE72056_quanTIseq_TIL10)[i], measure.vars = colnames(GSE72056_quanTIseq_TIL10)[i + 6])
}

RMSE <- data.frame(cell_type = c("CD4", "CD8", "Macrophages", "B", "NK", "Tregs"),
                   rmse = unlist(rmse))

p_GSE72056_quanTIseq[[1]] <- ggplot(melt_GSE72056_quanTIseq[[1]],aes(x = value, y = V)) + geom_point(colour = c("red"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.8)) + scale_y_continuous(name = NULL, limits = c(0,0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.37, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.163, y = 0.34, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6)
 

p_GSE72056_quanTIseq[[2]] <- ggplot(melt_GSE72056_quanTIseq[[2]],aes(x = value, y = V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.93, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.21, y = 0.865, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6) 

p_GSE72056_quanTIseq[[3]] <- ggplot(melt_GSE72056_quanTIseq[[3]],aes(x = value, y = V)) + geom_point(colour = c("coral"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.15)) + scale_y_continuous(name = NULL, limits = c(0,0.1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.093, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.0335, y = 0.0865, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)

p_GSE72056_quanTIseq[[4]] <- ggplot(melt_GSE72056_quanTIseq[[4]],aes(x = value, y = V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.5)) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.187, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.105, y = 0.173, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)

p_GSE72056_quanTIseq[[5]] <- ggplot(melt_GSE72056_quanTIseq[[5]],aes(x = value, y = V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.187, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.016, y = 0.173, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)

p_GSE72056_quanTIseq[[6]] <- ggplot(melt_GSE72056_quanTIseq[[6]],aes(x = value, y = V)) + geom_point(colour = c("darkgreen"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.187, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.0175, y = 0.17, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[6],2))))), parse = TRUE, size = 6)

# figure_GSE72056_quanTIseq <- ggarrange(p_GSE72056_quanTIseq[[1]], p_GSE72056_quanTIseq[[2]], p_GSE72056_quanTIseq[[3]], p_GSE72056_quanTIseq[[4]], p_GSE72056_quanTIseq[[5]], p_GSE72056_quanTIseq[[6]], ncol = 3, nrow = 2, labels = "c", font.label = list(size = 20, color = "black"))
# 
# figure_GSE72056_quanTIseq <- annotate_figure(figure_GSE72056_quanTIseq, left = text_grob("quanTIseq estimate", color = "black", size = 20, rot = 90), bottom = text_grob("Ture cell fractions", color = "black", size = 20))

```

############## MCP-counter ###################

```{r}

GSE72056_MCP_counter = as.data.frame(deconvolute(Melanoma_GSE72056_no_malighant, "mcp_counter"))
GSE72056_MCPcounter <- as.data.frame(t(column_to_rownames(GSE72056_MCP_counter,"cell_type")))

GSE72056_MCPcounter <- cbind(GSE72056_MCPcounter[,2], GSE72056_MCPcounter[,6], GSE72056_MCPcounter[,5],  GSE72056_MCPcounter[,4], GSE72056_MCPcounter[,c(10:11)])

colnames(GSE72056_MCPcounter) <- c("CD8","Macrophages","B","NK", "Endothelial","CAFs")

GSE72056_MCPcounter <- cbind(GSE72056_MCPcounter, Facs_Melanoma_GSE72056[, c(4,6,1,7,5,2)])

colnames(GSE72056_MCPcounter) <- c("V","V","V","V", "V","V", "CD8", "Macrophages", "B", "NK", "Endothelial","CAFs")


melt_GSE72056_MCPcounter <- list()
rmse <- list()
p_GSE72056_MCPcounter <- list()

for (i in c(1:6)) {
  
    rmse[[i]] <- rmse(GSE72056_MCPcounter[,i], GSE72056_MCPcounter[,i + 6])
    
    melt_GSE72056_MCPcounter[[i]] <- melt(GSE72056_MCPcounter[,c(i, i + 6)],  id.vars = colnames(GSE72056_MCPcounter)[i], measure.vars = colnames(GSE72056_MCPcounter)[i + 6])
}

RMSE <- data.frame(cell_type = c("CD8", "Macrophages", "B", "NK", "Endothelial","CAFs"),
                   rmse = unlist(rmse))

p_GSE72056_MCPcounter[[1]] <- ggplot( melt_GSE72056_MCPcounter[[1]],aes(x = value, y = V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,5)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 5, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 4.7, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.195, y = 4.35, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6)
 

p_GSE72056_MCPcounter[[2]] <- ggplot(melt_GSE72056_MCPcounter[[2]],aes(x = value, y = V)) + geom_point(colour = c("coral"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.2)) + scale_y_continuous(name = NULL, limits = c(0,0.8)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.8, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.75, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.042, y = 0.7, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

p_GSE72056_MCPcounter[[3]] <- ggplot(melt_GSE72056_MCPcounter[[3]],aes(x = value, y = V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.5)) + scale_y_continuous(name = NULL, limits = c(0,2.5)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 2.5, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 2.35, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.105, y = 2.2, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)

p_GSE72056_MCPcounter[[4]] <- ggplot(melt_GSE72056_MCPcounter[[4]],aes(x = value, y = V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,0.4)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.4, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.375, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.0165, y = 0.35, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)

p_GSE72056_MCPcounter[[5]] <- ggplot(melt_GSE72056_MCPcounter[[5]],aes(x = value, y = V)) + geom_point(colour = c("chartreuse"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,0.3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.3, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.28, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.0165, y = 0.26, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)

p_GSE72056_MCPcounter[[6]] <- ggplot(melt_GSE72056_MCPcounter[[6]],aes(x = value, y = V)) + geom_point(colour = c("darkorchid"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.12)) + scale_y_continuous(name = NULL) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 3, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 2.8, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.0242, y = 2.625, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[6],2))))), parse = TRUE, size = 6)



# figure_GSE72056_MCPcounter <- ggarrange(p_GSE72056_MCPcounter[[1]], p_GSE72056_MCPcounter[[2]], p_GSE72056_MCPcounter[[3]], p_GSE72056_MCPcounter[[4]], p_GSE72056_MCPcounter[[5]], p_GSE72056_MCPcounter[[6]], ncol = 3, nrow = 2, labels = "c", font.label = list(size = 20, color = "black"))
# 
# figure_GSE72056_MCPcounter <- annotate_figure(figure_GSE72056_MCPcounter, left = text_grob("MCP_counter estimate", color = "black", size = 20, rot = 90), bottom = text_grob("Ture cell fractions", color = "black", size = 20))

```




################# Figure 5 #######################

###################### Lymphocytes Figure_5a_b ###########################

```{r}
###################### Lymphocytes Figure_5a_b ###########################
library(cowplot)

annotate_TCGA_LUAD_CCLE_TIL10_BPRNACan <- ggarrange(annotate_figure_TCGA_LUAD_CCLE_TIL10, annotate_figure_TCGA_LUAD_BPRNACan, ncol = 1, nrow=2,  labels = "a", font.label = list(size = 20, color = "black"))

Fig_5a <- annotate_figure(annotate_TCGA_LUAD_CCLE_TIL10_BPRNACan, bottom = text_grob("H&E estimate", color = "black", size = 20))

Figure_5b <- 
  
  
  
  
  ggdraw()+ draw_plot(annotate_TCGA_LUAD_CCLE_TIL10_BPRNACan, x = 0.05, y = 0.5, width = 0.9, height = 0.5)+
    draw_plot(All_Methods_TCGA_LUAD_HE, x=0, y= 0, width = 1, height = 0.5) + 
    draw_plot_label(label = c("a", "b"), size = 20, x = c(0.01, 0.01), y=c(1, 0.5))
```

###################### Figure_5c ###########################

```{r}
###################### Ludo's Figure_5c ###########################

figure_Thomas_BPRNACan_150 <- ggarrange(Th[[1]],Th[[2]],Th[[3]], ncol = 3, nrow=1, labels = "c", font.label = list(size = 20, color = "black"))

figure_Thomas_BPRNACan_150 <- annotate_figure(figure_Thomas_BPRNACan_150,
               # bottom = text_grob("Gold standard", color = "black", size = 20),
                left = text_grob("BPRNACan estimate", color = "black", size = 20, rot = 90))

figure_Thomas_quanTIseq_M <- ggarrange(Thq[[1]],Thq[[2]],Thq[[3]], ncol = 3, nrow=1, font.label = list(size = 18, color = "black"))


figure_Thomas_quanTIseq_M <- annotate_figure(figure_Thomas_quanTIseq_M,
               # bottom = text_grob("Gold standard", color = "black", size = 20),
                left = text_grob("quanTIseq estimate", color = "black", size = 20, rot = 90))

figure_Thomas_MCP_counter_M <- ggarrange(Thm[[1]],Thm[[2]],Thm[[3]], ncol = 3, nrow=1, font.label = list(size = 18, color = "black"))


figure_Thomas_MCP_counter_M <- annotate_figure(figure_Thomas_MCP_counter_M,
               # bottom = text_grob("Gold standard", color = "black", size = 20),
                left = text_grob("MCP-counter estimate", color = "black", size = 20, rot = 90), bottom = text_grob("Gold standard", color = "black", size = 20))


 Mix_figure_BPRNACan_quanTIseq_M_MCP_counter <- ggarrange(figure_Thomas_BPRNACan_150, figure_Thomas_quanTIseq_M, figure_Thomas_MCP_counter_M,ncol = 1, nrow=3)
 
Figure_5c <- annotate_figure(Mix_figure_BPRNACan_quanTIseq_M_MCP_counter,
                 bottom = text_grob("Gold standard", color = "black", size = 20))

```

###################### scRNA-seq melanoma Figure_5d ###########################

```{r}
###################### scRNAseq ###########################
################ BPRNAseq #######################

p_GSE72056_BPRNACan_EpiDISH[[3]] <- ggplot(melt_GSE72056_BPRNACan_EpiDISH[[3]],aes(x = value, y = V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.85, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.17, y = 0.7, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)

p_GSE72056_BPRNACan_EpiDISH[[4]] <- ggplot(melt_GSE72056_BPRNACan_EpiDISH[[4]],aes(x = value, y = V)) + geom_point(colour = c("coral"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.15)) + scale_y_continuous(name = NULL, limits = c(0,0.1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.085, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.026, y = 0.071, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)

p_GSE72056_BPRNACan_EpiDISH[[5]] <- ggplot(melt_GSE72056_BPRNACan_EpiDISH[[5]],aes(x = value, y = V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.5)) + scale_y_continuous(name = NULL, limits = c(0,0.8)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.8, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.65, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.084, y = 0.53, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)

p_GSE72056_BPRNACan_EpiDISH[[6]] <- ggplot(melt_GSE72056_BPRNACan_EpiDISH[[6]],aes(x = value, y = V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,0.015)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.015, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.0125, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.0138, y = 0.010, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[6],2))))), parse = TRUE, size = 6)



figure_GSE72056_BPRNACan_EpiDISH_c <- ggarrange(p_GSE72056_BPRNACan_EpiDISH[[3]], p_GSE72056_BPRNACan_EpiDISH[[4]], p_GSE72056_BPRNACan_EpiDISH[[5]], p_GSE72056_BPRNACan_EpiDISH[[6]], ncol = 2, nrow = 2, labels = "d", font.label = list(size = 20, color = "black"))

figure_GSE72056_BPRNACan_EpiDISH_c <- annotate_figure(figure_GSE72056_BPRNACan_EpiDISH_c, left = text_grob("BPRNACan estimate", color = "black", size = 20, rot = 90))

############### quanTIseq #######################

p_GSE72056_quanTIseq[[2]] <- ggplot(melt_GSE72056_quanTIseq[[2]],aes(x = value, y = V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.85, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.17, y = 0.7, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6) 

p_GSE72056_quanTIseq[[3]] <- ggplot(melt_GSE72056_quanTIseq[[3]],aes(x = value, y = V)) + geom_point(colour = c("coral"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.15)) + scale_y_continuous(name = NULL, limits = c(0,0.1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.1, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.085, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.026, y = 0.071, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)

p_GSE72056_quanTIseq[[4]] <- ggplot(melt_GSE72056_quanTIseq[[4]],aes(x = value, y = V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.5)) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.168, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.078, y = 0.14, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)

p_GSE72056_quanTIseq[[5]] <- ggplot(melt_GSE72056_quanTIseq[[5]],aes(x = value, y = V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,0.2)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.2, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.168, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.013, y = 0.14, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[5],2))))), parse = TRUE, size = 6)



figure_GSE72056_quanTIseq_c <- ggarrange(p_GSE72056_quanTIseq[[2]], p_GSE72056_quanTIseq[[3]], p_GSE72056_quanTIseq[[4]], p_GSE72056_quanTIseq[[5]], ncol = 2, nrow = 2, font.label = list(size = 20, color = "black"))

figure_GSE72056_quanTIseq_c <- annotate_figure(figure_GSE72056_quanTIseq_c, left = text_grob("quanTIseq estimate", color = "black", size = 20, rot = 90))


################ MCP-counter #######################

p_GSE72056_MCPcounter[[1]] <- ggplot( melt_GSE72056_MCPcounter[[1]],aes(x = value, y = V)) + geom_point(colour = c("green"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = NULL, limits = c(0,6)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 6, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 5.15, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.161, y = 4.3, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[1],2))))), parse = TRUE, size = 6)


p_GSE72056_MCPcounter[[2]] <- ggplot(melt_GSE72056_MCPcounter[[2]],aes(x = value, y = V)) + geom_point(colour = c("coral"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.2)) + scale_y_continuous(name = NULL, limits = c(0,0.8)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.8, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.692, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.0325, y = 0.575, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[2],2))))), parse = TRUE, size = 6)

p_GSE72056_MCPcounter[[3]] <- ggplot(melt_GSE72056_MCPcounter[[3]],aes(x = value, y = V)) + geom_point(colour = c("darkgoldenrod1"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.5)) + scale_y_continuous(name = NULL, limits = c(0,3)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 3, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 2.6, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust=-0.5)) + annotate("text", x = 0.078, y = 2.15, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[3],2))))), parse = TRUE, size = 6)

p_GSE72056_MCPcounter[[4]] <- ggplot(melt_GSE72056_MCPcounter[[4]],aes(x = value, y = V)) + geom_point(colour = c("darkmagenta"), size = 6) + theme_bw() + stat_smooth(method = lm,color = "black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,0.08)) + scale_y_continuous(name = NULL, limits = c(0,0.5)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 0.5, size = 6) + stat_cor(method = "pearson", aes(label = paste(..p.label.., sep = '\n')), label.x = 0, label.y = 0.435, size = 6)  + theme(axis.title.y = element_text(vjust = 1.5)) +  theme(axis.title.x = element_text(vjust = -0.5)) + annotate("text", x = 0.013, y = 0.37, label = as.character(as.expression(substitute(paste(RMSE, " = ", r), list(r = round(RMSE$rmse[4],2))))), parse = TRUE, size = 6)

figure_GSE72056_MCPcounter_c <- ggarrange(p_GSE72056_MCPcounter[[1]], p_GSE72056_MCPcounter[[2]], p_GSE72056_MCPcounter[[3]], p_GSE72056_MCPcounter[[4]], ncol = 2, nrow = 2, font.label = list(size = 20, color = "black"))

figure_GSE72056_MCPcounter_c <- annotate_figure(figure_GSE72056_MCPcounter_c, left = text_grob("MCP_counter estimate", color = "black", size = 20, rot = 90), bottom = text_grob("Cell fraction estimates", color = "black", size = 20))


figure5d <- annotate_figure(ggarrange(figure_GSE72056_BPRNACan_EpiDISH_c, figure_GSE72056_quanTIseq_c, figure_GSE72056_MCPcounter_c, ncol = 1, nrow = 3, font.label = list(size = 20, color = "black")), bottom = text_grob("Cell fraction estimates", color = "black", size = 20))

```


  

############################ Start Figure S5 ############################ 

##########  RNAseq TCGA-LUAD with previous tumor purity methods ############

############## CCLE_TIL10 and BPRNACan ###################

```{r}

load("/home/ting/deconvolution/Final methylation paper/figure/Figure_S5/Figure_S5.RData")

out.l <- epidish(TCGA_LUADRNAseq_TumorPurity_Aran, CCLE_TIL10, "RPC", maxit = 100)
TCGA_LUAD_RNAseq_CCLE_TIL10 <- data.frame(out.l$estF)
TCGA_LUAD_RNAseq_CCLE_TIL10<-as.data.frame(cbind( TCGA_LUAD_RNAseq_CCLE_TIL10$Cancer.cells, Facs_LUAD_Aran$ABSOLUTE,  Facs_LUAD_Aran$ESTIMATE, Facs_LUAD_Aran$LUMP, Facs_LUAD_Aran$IHC))
colnames(TCGA_LUAD_RNAseq_CCLE_TIL10) <- c("CCLE_TIL10", "ABSOLUTE", "ESTIMATE","LUMP","IHC")

melt_CCLE_TIL10 <- melt(TCGA_LUAD_RNAseq_CCLE_TIL10,  id.vars = "CCLE_TIL10", measure.vars = c("ABSOLUTE", "ESTIMATE","LUMP","IHC"))


p_CCLE_TIL10 <- ggplot(melt_CCLE_TIL10,aes(x=value, y=CCLE_TIL10)) + geom_point(colour = "brown") + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = "CCLE_TIL10 estimate",limits = c(0,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor(aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0, label.y = 1, size = 6) + stat_cor(aes(label = paste(..p.label..)), label.x = 0, label.y = 0.86, size = 6) + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5)) + labs(tag = "a")

```

########### BPRNACan ####################

```{r}

out.l <- epidish(TCGA_LUADRNAseq_TumorPurity_Aran, BPRNACan, "RPC", maxit = 100)
TCGA_LUAD_RNAseq_BPRNACan_150 <- data.frame(out.l$estF)
TCGA_LUAD_RNAseq_BPRNACan_150<-as.data.frame(cbind(TCGA_LUAD_RNAseq_BPRNACan_150$cancer, Facs_LUAD_Aran$ABSOLUTE, Facs_LUAD_Aran$ESTIMATE,Facs_LUAD_Aran$LUMP,Facs_LUAD_Aran$IHC))
colnames(TCGA_LUAD_RNAseq_BPRNACan_150) <- c("BPRNACan", "ABSOLUTE", "ESTIMATE","LUMP","IHC")

melt_BPRNACan <- melt(TCGA_LUAD_RNAseq_BPRNACan_150,  id.vars = "BPRNACan", measure.vars = c("ABSOLUTE", "ESTIMATE","LUMP","IHC"))


p_BPRNACan <- ggplot(melt_BPRNACan,aes(x=value, y=BPRNACan)) + geom_point(colour = "brown") + theme_bw() + stat_smooth(method = lm,color="black") + facet_wrap(~ variable) + scale_x_continuous(name = NULL, limits = c(0,1)) + scale_y_continuous(name = "BPRNACan estimate", limits = c(0.8,1)) + theme(strip.text.x = element_text(size=18, color = "black", face="bold"),  text = element_text(size = 20)) + font("xy.text", size = 16, color = "black") + stat_cor( aes(label = paste(..r.label.., ..p.label.., sep = '\n')), label.x = 0.5, label.y = 0.83, size = 6) + stat_cor( aes(label = paste(..p.label..)), label.x = 0.5, label.y = 0.81, size = 6) + theme(axis.title.x = element_text(vjust=-0.5)) + theme(axis.title.y = element_text(vjust=1.5))  + labs(tag = "b")

```

############################ Figure S5 ############################

```{r}

Figure_S5 <- ggarrange(p_CCLE_TIL10, p_BPRNACan, ncol = 1, nrow=2, font.label = list(size = 20, color = "black"))

Figure_S5 <- annotate_figure(Figure_S5,
                bottom = text_grob("Method purity estimate", color = "black", size = 20))

```





############################ Start Figure S6 #################################### 
############ Test CCLE_TIL10 and BPRNACan using all public datasets (except PBMC)

### silico_1700

```{r}
load("~/deconvolution/Final methylation paper/figure/Figure_S6/Figure_S6.RData")

library(dplyr)

melt_silico_1700 <- melt(silico_1700)

melt_silico_1700_Pvalue <- melt(silico_1700_Pvalue)

merge_melt_silico_1700 <- cbind(melt_silico_1700, melt_silico_1700_Pvalue) %>% .[,-3]

melt_merge_melt_silico_1700 <- merge_melt_silico_1700 %>%
    mutate(text = case_when(  # 一定要 get 到 case_when() 函数奥秘
        is.na(value.1) & is.na(value) ~ paste("NA", "\n"),
        is.na(value.1) & (value == 0) ~ paste(value, "\n"),
        value.1 >= 0.05 ~ paste(value, "\n"),
        value.1 >= 0.01& value.1 < 0.05  ~ paste(value, "\n*"), # round() 只保留两位小数
        value.1 >= 0.001 & value.1 < 0.01 ~ paste(value, "\n**"),
        value.1 < 0.001 ~ paste(value, "\n***")))

melt_merge_melt_silico_1700$new_Var2 <- rownames(silico_1700_Pvalue)
melt_merge_melt_silico_1700$new_Var2 <- factor(melt_merge_melt_silico_1700$new_Var2, levels = unique(melt_merge_melt_silico_1700$new_Var2))

silico_1700_figure <- ggplot(melt_merge_melt_silico_1700, aes(new_Var2, variable)) + 
    geom_tile(aes(fill = value), colour = "grey", size = 1)+
    scale_fill_gradient2(low = "#5C5DAF",mid = "white",high = "#EA2E2D") + 
    
    geom_text(aes(label=text),col ="black",size = 5) +
    theme_minimal() + # 不要背景
    theme(axis.title.x=element_blank(), # 去掉 title
          axis.ticks.x=element_blank(), # 去掉x 轴
          axis.title.y=element_blank(), # 去掉 y 轴
          legend.title=element_text(size = 14),
          legend.text=element_text(size = 14),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 14, colour = "black"), # 调整x轴文字，字体加粗
          axis.text.y = element_text(size = 14, colour = "black")) + labs(fill =paste0("Correlation")) + ggtitle("1700 simulated RNA-seq data sets (ID: 6)") + theme(plot.title = element_text(hjust = 0.5, size = 16 )) 

Figure_S6a <- ggarrange(silico_1700_figure, ncol = 1, nrow = 1, labels = "a", font.label = list(size = 20, color = "black"))

```

### LUAD H&E RNAseq ###

```{r}

melt_TCGA_LUAD_Lymphocytes_RNAseq <- melt(TCGA_LUAD_Lymphocytes_RNAseq)

melt_TCGA_LUAD_Lymphocytes_RNAseq_Pvalue <- melt(TCGA_LUAD_Lymphocytes_RNAseq_Pvalue)

merge_TCGA_LUAD_Lymphocytes_RNAseq <- cbind(melt_TCGA_LUAD_Lymphocytes_RNAseq, melt_TCGA_LUAD_Lymphocytes_RNAseq_Pvalue) %>% .[,-3]

melt_merge_TCGA_LUAD_Lymphocytes_RNAseq <- merge_TCGA_LUAD_Lymphocytes_RNAseq %>%
    mutate(text = case_when(  # 一定要 get 到 case_when() 函数奥秘
        is.na(value.1) & is.na(value) ~ paste("NA", "\n"),
        is.na(value.1) & (value == 0) ~ paste(value, "\n"),
        value.1 >= 0.05 ~ paste(value, "\n"),
        value.1 >= 0.01& value.1 < 0.05  ~ paste(value, "\n*"), # round() 只保留两位小数
        value.1 >= 0.001 & value.1 < 0.01 ~ paste(value, "\n**"),
        value.1 < 0.001 ~ paste(value, "\n***")))

melt_merge_TCGA_LUAD_Lymphocytes_RNAseq$new_Var2 <- rownames(TCGA_LUAD_Lymphocytes_RNAseq_Pvalue)
melt_merge_TCGA_LUAD_Lymphocytes_RNAseq$new_Var2 <- factor(melt_merge_TCGA_LUAD_Lymphocytes_RNAseq$new_Var2, levels = unique(melt_merge_TCGA_LUAD_Lymphocytes_RNAseq$new_Var2))

TCGA_LUAD_Lymphocytes_RNAseq_figure <- ggplot(melt_merge_TCGA_LUAD_Lymphocytes_RNAseq, aes(new_Var2, variable)) + 
    geom_tile(aes(fill = value), colour = "grey", size = 1)+
    scale_fill_gradient2(low = "#5C5DAF",mid = "white",high = "#EA2E2D") + 
    
    geom_text(aes(label=text),col ="black",size = 5) +
    theme_minimal() + # 不要背景
    theme(axis.title.x=element_blank(), # 去掉 title
          axis.ticks.x=element_blank(), # 去掉x 轴
          axis.title.y=element_blank(), # 去掉 y 轴
          legend.title=element_text(size = 14),
          legend.text=element_text(size = 14),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 14, colour = "black"), # 调整x轴文字，字体加粗
          axis.text.y = element_text(size = 14, colour = "black")) + labs(fill =paste0("Correlation")) + ggtitle("H&E stained (ID: 4)") + theme(plot.title = element_text(hjust = 0.5, size = 16 ))


Figure_S6b <- ggarrange(TCGA_LUAD_Lymphocytes_RNAseq_figure, ncol = 1, nrow = 1, labels = "b", font.label = list(size = 20, color = "black"))
```

### Melanoma_GSE72056 ###

```{r}

melt_Melanoma_GSE72056 <- melt(Melanoma_GSE72056)

melt_Melanoma_GSE72056_Pvalue <- melt(Melanoma_GSE72056_Pvalue)

merge_Melanoma_GSE72056 <- cbind(melt_Melanoma_GSE72056, melt_Melanoma_GSE72056_Pvalue) %>% .[,-3]

melt_merge_Melanoma_GSE72056 <- merge_Melanoma_GSE72056 %>%
    mutate(text = case_when(  # 一定要 get 到 case_when() 函数奥秘
        is.na(value.1) & is.na(value) ~ paste("NA", "\n"),
        is.na(value.1) & (value == 0) ~ paste(value, "\n"),
        value.1 >= 0.05 ~ paste(value, "\n"),
        value.1 >= 0.01& value.1 < 0.05  ~ paste(value, "\n*"), # round() 只保留两位小数
        value.1 >= 0.001 & value.1 < 0.01 ~ paste(value, "\n**"),
        value.1 < 0.001 ~ paste(value, "\n***")))

melt_merge_Melanoma_GSE72056$new_Var2 <- rownames(Melanoma_GSE72056)
melt_merge_Melanoma_GSE72056$new_Var2 <- factor(melt_merge_Melanoma_GSE72056$new_Var2, levels = unique(melt_merge_Melanoma_GSE72056$new_Var2))

Melanoma_GSE72056_figure <- ggplot(melt_merge_Melanoma_GSE72056, aes(new_Var2, variable)) + 
    geom_tile(aes(fill = value), colour = "grey", size = 1)+
    scale_fill_gradient2(low = "#5C5DAF",mid = "white",high = "#EA2E2D") + 
    
    geom_text(aes(label=text),col ="black",size = 5) +
    theme_minimal() + # 不要背景
    theme(axis.title.x=element_blank(), # 去掉 title
          axis.ticks.x=element_blank(), # 去掉x 轴
          axis.title.y=element_blank(), # 去掉 y 轴
          legend.title=element_text(size = 14),
          legend.text=element_text(size = 14),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 14, colour = "black"), # 调整x轴文字，字体加粗
          axis.text.y = element_text(size = 14, colour = "black")) + labs(fill =paste0("Correlation")) + ggtitle("19 reconstructed non-malignant melanoma (ID: 9)") + theme(plot.title = element_text(hjust = 0.5, size = 16 ))

Figure_S6c <- ggarrange(Melanoma_GSE72056_figure, ncol = 1, nrow = 1, labels = "c", font.label = list(size = 20, color = "black"))

```

### Melanoma_GSE93722 ###

```{r}

melt_Melanoma_GSE93722 <- melt(Melanoma_GSE93722)

melt_Melanoma_GSE93722_Pvalue <- melt(Melanoma_GSE93722_Pvalue)

merge_Melanoma_GSE93722 <- cbind(melt_Melanoma_GSE93722, melt_Melanoma_GSE93722_Pvalue) %>% .[,-3]

melt_merge_Melanoma_GSE93722 <- merge_Melanoma_GSE93722 %>%
    mutate(text = case_when(  # 一定要 get 到 case_when() 函数奥秘
        is.na(value.1) & is.na(value) ~ paste("NA", "\n"),
        is.na(value.1) & (value == 0) ~ paste(value, "\n"),
        value.1 >= 0.05 ~ paste(value, "\n"),
        value.1 >= 0.01& value.1 < 0.05  ~ paste(value, "\n*"), # round() 只保留两位小数
        value.1 >= 0.001 & value.1 < 0.01 ~ paste(value, "\n**"),
        value.1 < 0.001 ~ paste(value, "\n***")))

melt_merge_Melanoma_GSE93722$new_Var2 <- rownames(Melanoma_GSE93722)
melt_merge_Melanoma_GSE93722$new_Var2 <- factor(melt_merge_Melanoma_GSE93722$new_Var2, levels = unique(melt_merge_Melanoma_GSE93722$new_Var2))

Melanoma_GSE93722_figure <- ggplot(melt_merge_Melanoma_GSE93722, aes(new_Var2, variable)) + 
    geom_tile(aes(fill = value), colour = "grey", size = 1)+
    scale_fill_gradient2(low = "#5C5DAF",mid = "white",high = "#EA2E2D") + 
    
    geom_text(aes(label=text),col ="black",size = 5) +
    theme_minimal() + # 不要背景
    theme(axis.title.x=element_blank(), # 去掉 title
          axis.ticks.x=element_blank(), # 去掉x 轴
          axis.title.y=element_blank(), # 去掉 y 轴
          legend.title=element_text(size = 14),
          legend.text=element_text(size = 14),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 14, colour = "black"), # 调整x轴文字，字体加粗
          axis.text.y = element_text(size = 14, colour = "black")) + labs(fill =paste0("Correlation")) + ggtitle("4 malignant melanoma (ID: 8)") + theme(plot.title = element_text(hjust = 0.5, size = 16 ))

Figure_S6d <- ggarrange(Melanoma_GSE93722_figure, ncol = 1, nrow = 1, labels = "d", font.label = list(size = 20, color = "black"))

```







